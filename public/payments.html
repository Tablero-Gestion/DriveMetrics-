<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriveMetrics Pro - Sistema de Pagos Integrado</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #334155; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .header h1 { color: #1e293b; font-size: 28px; font-weight: 700; }
        .auth-section { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .metrics-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .metric-card.limited { opacity: 0.6; pointer-events: none; }
        .metric-card h3 { color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .platform-status { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e2e8f0; }
        .platform-status:last-child { border-bottom: none; }
        .platform-name { font-weight: 600; color: #374151; }
        .platform-metrics { display: flex; gap: 16px; font-size: 14px; }
        .demand { color: #059669; } .surge { color: #dc2626; } .earnings { color: #7c3aed; }
        .recommendations { background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px; margin-top: 20px; }
        .recommendation-item { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
        .recommendation-item:last-child { margin-bottom: 0; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #374151; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
        .form-group input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border-radius: 8px; font-weight: 600; text-decoration: none; border: none; cursor: pointer; transition: all 0.2s; font-size: 16px; min-height: 44px; }
        .btn-primary { background: #4f46e5; color: white; } .btn-primary:hover { background: #4338ca; }
        .btn-secondary { background: #f9fafb; color: #6b7280; border: 1px solid #e5e7eb; }
        .btn-logout { background: #ef4444; color: white; }
        .user-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: #f1f5f9; border-radius: 8px; }
        .hidden { display: none; } .loading { text-align: center; padding: 40px; color: #6b7280; }
        .error-message { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        .success-message { background: #d1fae5; color: #065f46; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        .premium-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.95); display:flex; align-items:center; justify-content:center; border-radius: 12px; backdrop-filter: blur(2px); }
        .premium-message { text-align: center; padding: 20px; }
        .premium-message h4 { color: #7c3aed; margin-bottom: 8px; }
        .premium-message p { color: #6b7280; margin-bottom: 16px; font-size: 14px; }
        .subscription-status.trial { color:#92400e; }
        .subscription-status.active { color:#065f46; }
        .subscription-status.expired { color:#991b1b; }
    </style>
    <link rel="stylesheet" href="payment-styles.css">
</head>
<body>
    <div class="header"><div class="container"><h1>üöó DriveMetrics Pro</h1></div></div>
    <div class="container">
        <div id="auth-section" class="auth-section">
            <div id="login-form">
                <h2>Iniciar Sesi√≥n</h2>
                <div class="form-group"><label for="email">Email:</label><input type="email" id="email" placeholder="tu@email.com"></div>
                <div class="form-group"><label for="password">Contrase√±a:</label><input type="password" id="password" placeholder="Tu contrase√±a"></div>
                <button class="btn btn-primary" onclick="handleLogin()">Iniciar Sesi√≥n</button>
                <button class="btn btn-secondary" onclick="showRegisterForm()">¬øNo tienes cuenta? Reg√≠strate</button>
            </div>
            <div id="register-form" class="hidden">
                <h2>Crear Cuenta</h2>
                <div class="form-group"><label for="reg-name">Nombre Completo:</label><input type="text" id="reg-name" placeholder="Tu nombre completo"></div>
                <div class="form-group"><label for="reg-email">Email:</label><input type="email" id="reg-email" placeholder="tu@email.com"></div>
                <div class="form-group"><label for="reg-phone">Tel√©fono (opcional):</label><input type="tel" id="reg-phone" placeholder="+54 9 11 1234 5678"></div>
                <div class="form-group"><label for="reg-password">Contrase√±a:</label><input type="password" id="reg-password" placeholder="M√≠nimo 6 caracteres"></div>
                <button class="btn btn-primary" onclick="handleRegister()">Crear Cuenta - 15 d√≠as gratis</button>
                <button class="btn btn-secondary" onclick="showLoginForm()">¬øYa tienes cuenta? Inicia sesi√≥n</button>
            </div>
        </div>

        <div id="dashboard-section" class="hidden">
            <div class="user-info">
                <div>
                    <strong id="user-name">Usuario</strong>
                    <div id="subscription-status" class="subscription-status trial">Prueba gratuita - <span id="days-left">15</span> d√≠as restantes</div>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="paymentSystem.showSubscriptionModal()">Suscribirse</button>
                    <button class="btn btn-logout" onclick="handleLogout()">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <div class="metrics-dashboard">
                <div class="metric-card" id="platforms-card">
                    <h3>üìä Estado de Plataformas</h3>
                    <div id="platforms-data"><div class="loading">Cargando m√©tricas...</div></div>
                </div>
                <div class="metric-card" id="recommendations-card">
                    <h3>üí° Recomendaciones</h3>
                    <div id="recommendations-data"><div class="loading">Cargando recomendaciones...</div></div>
                </div>
                <div class="metric-card" id="location-card">
                    <h3>üìç Ubicaci√≥n Actual</h3>
                    <div id="location-data"><div class="loading">Obteniendo ubicaci√≥n...</div></div>
                </div>
                <div class="metric-card" id="earnings-card">
                    <h3>üí∞ Ganancias Proyectadas <span class="drive-metrics-premium-badge">PREMIUM</span></h3>
                    <div id="earnings-data">
                        <div class="premium-overlay"><div class="premium-message"><h4>üîí Funci√≥n Premium</h4><p>Suscr√≠bete para ver an√°lisis detallados de ganancias</p><button class="btn btn-primary btn-small" onclick="paymentSystem.showSubscriptionModal()">Suscribirse Ahora</button></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error-messages"></div>
    </div>

    <script src="quickImplementation.js"></script>
    <script src="payment-system.js"></script>
    <script>
        // Instanciar sin afectar dashboard principal
        window.paymentSystem = new PaymentSystem();

        let isAuthenticated = false;
        let currentUser = null;
        let metricsInterval = null;

        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('authToken');
            if (token) {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (userData.email) {
                    await authenticateUser(userData);
                }
            }
        });

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) { showError('Por favor, completa todos los campos'); return; }
            try {
                const result = await window.paymentSystem.login(email, password);
                if (result.success) { await authenticateUser(result.data.user); showSuccess('¬°Bienvenido de vuelta!'); }
                else { showError(result.error); }
            } catch (error) { showError('Error de conexi√≥n: ' + error.message); }
        }

        async function handleRegister() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const phone = document.getElementById('reg-phone').value;
            const password = document.getElementById('reg-password').value;
            if (!name || !email || !password) { showError('Por favor, completa todos los campos obligatorios'); return; }
            if (password.length < 6) { showError('La contrase√±a debe tener al menos 6 caracteres'); return; }
            try {
                const result = await window.paymentSystem.register({ full_name: name, email, phone, password });
                if (result.success) { await authenticateUser(result.data.user); showSuccess('¬°Cuenta creada exitosamente! Tienes 15 d√≠as de prueba gratuita.'); }
                else { showError(result.error); }
            } catch (error) { showError('Error de conexi√≥n: ' + error.message); }
        }

        async function authenticateUser(userData) {
            isAuthenticated = true; currentUser = userData;
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('user-name').textContent = userData.full_name || userData.email;
            await updateSubscriptionStatus(); startMetricsUpdates();
        }

        async function updateSubscriptionStatus() {
            const status = await window.paymentSystem.checkSubscriptionStatus();
            if (status) {
                const statusElement = document.getElementById('subscription-status');
                if (status.subscription_status === 'trial' && status.trial_days_left > 0) {
                    statusElement.className = 'subscription-status trial';
                    statusElement.innerHTML = `Prueba gratuita - <span id="days-left">${status.trial_days_left||15}</span> d√≠as restantes`;
                } else if (status.subscription_status === 'active') {
                    statusElement.className = 'subscription-status active'; statusElement.textContent = 'Suscripci√≥n Activa';
                    document.querySelectorAll('.premium-overlay').forEach(o=>o.remove());
                } else { statusElement.className = 'subscription-status expired'; statusElement.textContent = 'Suscripci√≥n Expirada'; }
            }
        }

        function handleLogout() { window.paymentSystem.logout(); isAuthenticated=false; currentUser=null; document.getElementById('email').value=''; document.getElementById('password').value=''; document.getElementById('auth-section').classList.remove('hidden'); document.getElementById('dashboard-section').classList.add('hidden'); if (metricsInterval) clearInterval(metricsInterval); showSuccess('Sesi√≥n cerrada correctamente'); }

        async function startMetricsUpdates(){ await updateMetrics(); metricsInterval = setInterval(updateMetrics, 120000); }
        async function updateMetrics(){
            try {
                const result = await window.paymentSystem.getEnhancedRealTimeData();
                if (result) {
                    updatePlatformsData(result.platforms || {});
                    updateRecommendations(result.recommendations || []);
                    updateLocation(result.location);
                    if (result.limited) { showLimitedAccessMessage(); }
                }
            } catch (e) { console.error('Error updating metrics:', e); showError('Error actualizando m√©tricas'); }
        }

        function updatePlatformsData(platforms){
            const container = document.getElementById('platforms-data');
            const names = { uber:'Uber', didi:'DiDi', pedidosya:'PedidosYa', rappi:'Rappi' };
            container.innerHTML = Object.entries(platforms).map(([k,d])=>`
                <div class="platform-status">
                    <div class="platform-name">${names[k]||k}</div>
                    <div class="platform-metrics">
                        <span class="demand">Demanda: ${d.demand}%</span>
                        <span class="surge">Surge: ${d.surge}x</span>
                        <span class="earnings">$${d.avgEarnings}/viaje</span>
                    </div>
                </div>`).join('');
        }

        function updateRecommendations(recs){
            const container = document.getElementById('recommendations-data');
            if (!recs.length) { container.innerHTML = '<p>No hay recomendaciones disponibles en este momento.</p>'; return; }
            container.innerHTML = recs.map(r=>{
                const icon = r.type==='platform'?'üöó':'‚è∞';
                return `<div class="recommendation-item"><span>${icon}</span><div><strong>${r.message}</strong><p style="margin:4px 0 0 0; font-size:14px; color:#6b7280;">${r.detail||''}</p></div></div>`;
            }).join('');
        }

        function updateLocation(location){
            const container = document.getElementById('location-data');
            if (location) {
                container.innerHTML = `<p><strong>Provincia:</strong> ${location.province}</p><p><strong>Ciudad:</strong> ${location.city}</p><p style="font-size:14px;color:#6b7280;margin-top:8px;">Coordenadas: ${location.coordinates?.lat?.toFixed(4)}, ${location.coordinates?.lng?.toFixed(4)}</p>`;
            } else { container.innerHTML = '<p>No se pudo obtener la ubicaci√≥n</p>'; }
        }

        function showLimitedAccessMessage(){ const card = document.getElementById('earnings-card'); if(card && !card.querySelector('.premium-overlay')){ const overlay=document.createElement('div'); overlay.className='premium-overlay'; overlay.innerHTML = `<div class="premium-message"><h4>üîí Funci√≥n Premium</h4><p>Tu per√≠odo de prueba ha expirado</p><button class="btn btn-primary btn-small" onclick="paymentSystem.showSubscriptionModal()">Suscribirse Ahora</button></div>`; card.appendChild(overlay); } }
        function showLoginForm(){ document.getElementById('login-form').classList.remove('hidden'); document.getElementById('register-form').classList.add('hidden'); }
        function showRegisterForm(){ document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); }
        function showError(message){ const c=document.getElementById('error-messages'); c.innerHTML=`<div class="error-message">${message}</div>`; setTimeout(()=>{ c.innerHTML=''; }, 5000); }
        function showSuccess(message){ const c=document.getElementById('error-messages'); c.innerHTML=`<div class="success-message">${message}</div>`; setTimeout(()=>{ c.innerHTML=''; }, 5000); }
        window.addEventListener('paymentSuccess', ()=>{ showSuccess('¬°Pago exitoso! Tu suscripci√≥n se ha activado.'); updateSubscriptionStatus(); setTimeout(()=>location.reload(),2000); });
        window.addEventListener('paymentError', (e)=>{ showError('Error en el pago: '+(e.detail?.message||'')); });
    </script>
</body>
</html>


