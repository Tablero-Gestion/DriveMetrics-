<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriveMetrics - Dashboard</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .loading-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity .5s ease; }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        .loading-logo { font-size: 4rem; margin-bottom: 1rem; animation: bounce 1s infinite; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        .loading-text { color: #fff; font-size: 1.2rem; margin-bottom: 2rem; }
        .spinner { border: 4px solid rgba(255,255,255,.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
        .login-container { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:1000; transition: all .5s ease; }
        .login-box { background:#fff; padding:2.5rem; border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,.2); text-align:center; max-width:420px; width:90%; transform:scale(.9); animation: scaleIn .5s ease forwards; }
        @keyframes scaleIn { to { transform: scale(1);} }
        .logo { font-size:2.5rem; color:#667eea; margin-bottom:1rem; }
        .title { font-size:1.8rem; color:#333; margin-bottom:.5rem; font-weight:600; }
        .subtitle { color:#666; margin-bottom:2rem; font-size:.95rem; }
        .google-btn { display:inline-flex; align-items:center; justify-content:center; gap:12px; background:#4285f4; color:#fff; border:none; padding:16px 24px; border-radius:50px; font-size:1.1rem; font-weight:500; cursor:pointer; transition: all .3s ease; width:100%; margin-bottom:1rem; }
        .google-btn:hover { background:#3367d6; transform: translateY(-2px); box-shadow:0 8px 25px rgba(66,133,244,.4); }
        .google-btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }
        .google-icon { width:22px; height:22px; background:#fff; border-radius:4px; padding:3px; flex-shrink:0; }
        .message { padding:12px; border-radius:8px; margin-top:1rem; font-size:.9rem; display:none; }
        .error-message { background:#fee; border:1px solid #fcc; color:#c33; }
        .success-message { background:#efe; border:1px solid #cfc; color:#3c3; }
        .dashboard { opacity:0; pointer-events:none; transition:opacity .5s ease; min-height:100vh; padding:20px; }
        .dashboard.active { opacity:1; pointer-events:all; }
        .dashboard-header { background:#fff; padding:1rem 2rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1); margin-bottom:2rem; display:flex; justify-content:space-between; align-items:center; }
        .user-info { display:flex; align-items:center; gap:15px; }
        .user-avatar { width:50px; height:50px; border-radius:50%; border:3px solid #667eea; }
        .user-details h3 { margin:0; color:#333; font-size:1.1rem; }
        .user-details p { margin:0; color:#666; font-size:.9rem; }
        .logout-btn { background:#dc3545; color:#fff; border:none; padding:10px 20px; border-radius:25px; cursor:pointer; font-size:.9rem; transition: all .3s ease; }
        .logout-btn:hover { background:#c82333; transform: translateY(-1px); }
        .dashboard-content { background:#fff; padding:2rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.1); }
        .welcome-section { text-align:center; margin-bottom:3rem; }
        .welcome-section h1 { color:#667eea; font-size:2.5rem; margin-bottom:1rem; }
        .welcome-section p { color:#666; font-size:1.1rem; }
        .calculator-section { background:#f8f9fa; padding:2rem; border-radius:12px; margin-top:2rem; border-left:4px solid #667eea; }
        .calculator-section h2 { color:#667eea; margin-bottom:1rem; }
        .hidden { display:none !important; }
        .fade-in { animation: fadeIn .5s ease forwards; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
        @media (max-width:768px){ .dashboard-header{flex-direction:column; gap:1rem} .user-info{justify-content:center} }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">ðŸš—</div>
        <div class="loading-text">Cargando DriveMetrics...</div>
        <div class="spinner"></div>
    </div>

    <div class="login-container hidden" id="loginContainer">
        <div class="login-box">
            <div class="logo">ðŸš—</div>
            <h1 class="title">DriveMetrics</h1>
            <p class="subtitle">Inicia sesiÃ³n para acceder a tu dashboard de mÃ©tricas de conducciÃ³n</p>
            <button class="google-btn" id="googleLoginBtn" onclick="iniciarGoogleAuth()">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar con Google
            </button>
            <div class="message error-message" id="errorMessage"></div>
            <div class="message success-message" id="successMessage"></div>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="dashboard-header">
            <div class="user-info">
                <img class="user-avatar" id="userAvatar" src="" alt="Avatar">
                <div class="user-details">
                    <h3 id="userName">Cargando...</h3>
                    <p id="userEmail">Cargando...</p>
                </div>
            </div>
            <button class="logout-btn" onclick="cerrarSesion()">Cerrar SesiÃ³n</button>
        </div>
        <div class="dashboard-content">
            <div class="welcome-section">
                <h1>Â¡Bienvenido a DriveMetrics!</h1>
                <p>Tu dashboard personalizado estÃ¡ listo. SesiÃ³n iniciada correctamente.</p>
            </div>
            <div class="calculator-section">
                <h2>ðŸ“Š Tu Calculadora de MÃ©tricas</h2>
                <p>AquÃ­ puedes integrar tu calculadora existente de DriveMetrics.</p>
                <div style="background:#fff; padding:1.5rem; border-radius:8px; margin-top:1rem;">
                    <h3>MÃ©tricas de ConducciÃ³n</h3>
                    <p>Usuario autenticado: <span id="dashboardUserName">Cargando...</span></p>
                    <p>Estado de sesiÃ³n: <span style="color:green;">âœ… Activa</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_CLIENT_ID = '151117015962-qhq4at3nbja8q9rq7qvspcc0sunr113u.apps.googleusercontent.com';
        const firebaseConfig = {
            apiKey: 'AIzaSyCFDb40oDXxQRG4PY0GAIaC8Ck7zS9tm0A',
            authDomain: 'drivemetrics-9ef78.firebaseapp.com',
            projectId: 'drivemetrics-9ef78',
            storageBucket: 'drivemetrics-9ef78.firebasestorage.app',
            messagingSenderId: '151117015962',
            appId: '1:151117015962:web:576aff049892be2760e823'
        };
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async function() {
            mostrarPantalla('loading');
            try {
                await new Promise(r => setTimeout(r, 600));
                if (window.firebase && !firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const sesion = await verificarSesionExistente();
                if (sesion) {
                    await mostrarDashboard(sesion);
                } else {
                    const redirectHecho = await procesarRedirectResult();
                    if (!redirectHecho) mostrarPantalla('login');
                }
            } catch(e) {
                console.error(e); mostrarPantalla('login');
            }
        });

        async function iniciarGoogleAuth(){
            const btn = document.getElementById('googleLoginBtn');
            try{
                btn.disabled = true; btn.textContent = 'Iniciando...';
                if (window.firebase && firebase.auth){
                    const auth = firebase.auth();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email'); provider.addScope('profile'); provider.setCustomParameters({ prompt: 'select_account' });
                    try{
                        const result = await auth.signInWithPopup(provider);
                        await manejarAutenticacionExitosa(result.user);
                    }catch(err){
                        if (err.code === 'auth/popup-blocked') { await auth.signInWithRedirect(provider); }
                        else { throw err; }
                    }
                } else { throw new Error('Firebase no estÃ¡ disponible'); }
            }catch(err){ manejarErrorLogin(err); }
            finally{ btn.disabled = false; btn.textContent = 'Continuar con Google'; }
        }

        async function procesarRedirectResult(){
            if (!(window.firebase && firebase.auth)) return false;
            try{
                const result = await firebase.auth().getRedirectResult();
                if (result && result.user){ await manejarAutenticacionExitosa(result.user); return true; }
            }catch(err){ manejarErrorLogin(err); }
            return false;
        }

        async function verificarSesionExistente(){
            const saved = localStorage.getItem('drivemetrics_user');
            if (saved){ try { return JSON.parse(saved); } catch{ localStorage.removeItem('drivemetrics_user'); } }
            if (window.firebase && firebase.auth){
                return new Promise((resolve)=>{
                    const unsub = firebase.auth().onAuthStateChanged((user)=>{
                        unsub(); resolve(user ? { id:user.uid, email:user.email, name:user.displayName, picture:user.photoURL, provider:'google' } : null);
                    });
                });
            }
            return null;
        }

        async function manejarAutenticacionExitosa(user){
            const userData = { id:user.uid, email:user.email, name:user.displayName, picture:user.photoURL, provider:'google', loginTime:new Date().toISOString() };
            localStorage.setItem('drivemetrics_user', JSON.stringify(userData));
            currentUser = userData; await mostrarDashboard(userData);
        }

        async function mostrarDashboard(userData){
            document.getElementById('userAvatar').src = userData.picture || 'https://via.placeholder.com/50';
            document.getElementById('userName').textContent = userData.name || 'Usuario';
            document.getElementById('userEmail').textContent = userData.email || '';
            document.getElementById('dashboardUserName') && (document.getElementById('dashboardUserName').textContent = userData.name || 'Usuario');
            mostrarPantalla('dashboard');
        }

        async function cerrarSesion(){
            try{ if (window.firebase && firebase.auth) await firebase.auth().signOut(); }catch{}
            localStorage.removeItem('drivemetrics_user'); currentUser=null; mostrarPantalla('login');
        }

        function mostrarPantalla(tipo){
            const loading = document.getElementById('loadingScreen');
            const login = document.getElementById('loginContainer');
            const dash = document.getElementById('dashboard');
            loading.classList.add('hidden'); login.classList.add('hidden'); dash.classList.remove('active');
            if (tipo==='loading') loading.classList.remove('hidden');
            if (tipo==='login') login.classList.remove('hidden');
            if (tipo==='dashboard') dash.classList.add('active');
        }

        function manejarErrorLogin(error){
            console.error('Login error', error);
            let m='Error al iniciar sesiÃ³n';
            if(error.code==='auth/unauthorized-domain') m='Dominio no autorizado en Firebase';
            if(error.code==='auth/popup-blocked') m='Popup bloqueado: permita popups o use redirect';
            mostrarError(m);
        }
        function mostrarError(m){ const el=document.getElementById('errorMessage'); if(el){ el.textContent=m; el.style.display='block'; setTimeout(()=>el.style.display='none',5000);} }
        function mostrarExito(m){ const el=document.getElementById('successMessage'); if(el){ el.textContent=m; el.style.display='block'; setTimeout(()=>el.style.display='none',3000);} }

        window.iniciarGoogleAuth = iniciarGoogleAuth;
        window.cerrarSesion = cerrarSesion;
        window.getCurrentUser = () => currentUser;
    </script>
</body>
</html>


