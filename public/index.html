<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriveMetrics - Dashboard</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="/payment-styles.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .loading-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity .5s ease; }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        .loading-logo { font-size: 4rem; margin-bottom: 1rem; animation: bounce 1s infinite; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        .loading-text { color: #fff; font-size: 1.2rem; margin-bottom: 2rem; }
        .spinner { border: 4px solid rgba(255,255,255,.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
        .login-container { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:1000; transition: all .5s ease; }
        .login-box { background:#fff; padding:2.5rem; border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,.2); text-align:center; max-width:420px; width:90%; transform:scale(.9); animation: scaleIn .5s ease forwards; }
        @keyframes scaleIn { to { transform: scale(1);} }
        .logo { font-size:2.5rem; color:#667eea; margin-bottom:1rem; }
        .title { font-size:1.8rem; color:#333; margin-bottom:.5rem; font-weight:600; }
        .subtitle { color:#666; margin-bottom:2rem; font-size:.95rem; }
        .google-btn { display:inline-flex; align-items:center; justify-content:center; gap:12px; background:#4285f4; color:#fff; border:none; padding:16px 24px; border-radius:50px; font-size:1.1rem; font-weight:500; cursor:pointer; transition: all .3s ease; width:100%; margin-bottom:1rem; }
        .google-btn:hover { background:#3367d6; transform: translateY(-2px); box-shadow:0 8px 25px rgba(66,133,244,.4); }
        .google-btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }
        .google-icon { width:22px; height:22px; background:#fff; border-radius:4px; padding:3px; flex-shrink:0; }
        .message { padding:12px; border-radius:8px; margin-top:1rem; font-size:.9rem; display:none; }
        .error-message { background:#fee; border:1px solid #fcc; color:#c33; }
        .success-message { background:#efe; border:1px solid #cfc; color:#3c3; }
        .dashboard { opacity:0; pointer-events:none; transition:opacity .5s ease; min-height:100vh; padding:20px; }
        .dashboard.active { opacity:1; pointer-events:all; }
        .dashboard-header { background:#fff; padding:1rem 2rem; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1); margin-bottom:2rem; display:flex; justify-content:space-between; align-items:center; }
        .user-info { display:flex; align-items:center; gap:15px; }
        .user-avatar { width:50px; height:50px; border-radius:50%; border:3px solid #667eea; }
        .user-details h3 { margin:0; color:#333; font-size:1.1rem; }
        .user-details p { margin:0; color:#666; font-size:.9rem; }
        .logout-btn { background:#dc3545; color:#fff; border:none; padding:10px 20px; border-radius:25px; cursor:pointer; font-size:.9rem; transition: all .3s ease; }
        .logout-btn:hover { background:#c82333; transform: translateY(-1px); }
        .dashboard-content { background:#fff; padding:2rem; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.1); }
        .welcome-section { text-align:center; margin-bottom:3rem; }
        .welcome-section h1 { color:#667eea; font-size:2.5rem; margin-bottom:1rem; }
        .welcome-section p { color:#666; font-size:1.1rem; }
        .calculator-section { background:#f8f9fa; padding:2rem; border-radius:12px; margin-top:2rem; border-left:4px solid #667eea; }
        .calculator-section h2 { color:#667eea; margin-bottom:1rem; }
        .hidden { display:none !important; }
        .fade-in { animation: fadeIn .5s ease forwards; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
        @media (max-width:768px){ .dashboard-header{flex-direction:column; gap:1rem} .user-info{justify-content:center} }

        /* === Estilos de la calculadora (según tu diseño) === */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; color: white; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .calculator-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .input-section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .results-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); color: white; }
        .section-title { font-size: 1.5rem; margin-bottom: 20px; font-weight: 700; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #667eea; }
        .platform-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .platform-btn { padding: 15px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s ease; font-weight: 600; }
        .platform-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .calculate-btn { width: 100%; padding: 15px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: transform 0.3s ease; }
        .calculate-btn:hover { transform: translateY(-2px); }
        .result-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 15px; backdrop-filter: blur(10px); }
        .result-title { font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; }
        .result-value { font-size: 2rem; font-weight: 700; }
        .recommendations { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; }
        .export-btn { background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 10px 5px; }
        @media (max-width: 768px) { .calculator-container { grid-template-columns: 1fr; } .platform-selector { grid-template-columns: 1fr; } .header h1 { font-size: 2rem; } }

        /* Predictor IA (según diseño solicitado) */
        .predictor-ia-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; border-radius: 15px; margin: 30px 0; color: white; }
        .predictor-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .prediccion-card { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease; }
        .prediccion-card:hover { transform: translateY(-5px); }
        .prediccion-card.full-width { grid-column: 1 / -1; }
        .ia-icon { font-size: 2rem; margin-bottom: 10px; text-align: center; }
        .prediccion-card h3 { margin-bottom: 15px; font-size: 1.2rem; text-align: center; }
        .prediccion-content { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-left: 4px solid #ffd700; font-size: 0.95rem; line-height: 1.5; }
        .prediccion-highlight { color: #ffd700; font-weight: bold; font-size: 1.1rem; }
        .prediccion-numero { color: #00ff88; font-weight: bold; font-size: 1.2rem; }

        /* Mapa de calor - Zonas Premium */
        .mapa-calor-section { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 30px 0; }
        .ubicacion-detector { text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; }
        .detectar-btn { background: #fff; color: #667eea; padding: 15px 30px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: all .3s ease; }
        .detectar-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .ubicacion-info { margin-top: 15px; color: #fff; font-size: 1.1rem; }
        .mapa-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .zona-actual-card, .zonas-premium-card, .comparacion-zonas, .horarios-zona { background: #f8f9ff; padding: 20px; border-radius: 10px; }
        .zona-actual-card h3, .zonas-premium-card h3, .comparacion-zonas h3, .horarios-zona h3 { color: #667eea; margin-bottom: 15px; font-size: 1.1rem; }
        .zona-premium-item { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#fff; border-radius:5px; margin-bottom:8px; }
        .zona-nombre-premium { font-weight:600; }
        .zona-ganancia { color:#00ff88; font-weight:bold; }
        .zona-comparacion { display:grid; grid-template-columns:2fr 1fr 1fr; gap:10px; padding:12px; background:#fff; border-radius:5px; margin-bottom:8px; align-items:center; }
        .zona-potencial { color:#667eea; font-weight:bold; }
        .zona-diferencia { background:#00ff88; color:#fff; padding:5px 10px; border-radius:15px; text-align:center; font-size:.9rem; font-weight:bold; }
        .zona-diferencia.negativa { background:#ff4757; }
        .horario-zona-item { background:#fff; padding:12px; border-radius:5px; margin-bottom:10px; }
        .horario-zona-titulo { font-weight:600; color:#333; margin-bottom:5px; }
        .horario-zona-detalle { font-size:.9rem; color:#666; }
        .alerta-zona { background: linear-gradient(45deg, #ff6b6b, #ee5a6f); color:#fff; padding:15px; border-radius:8px; margin-top:15px; text-align:center; }

        /* Alertas de Horarios Premium */
        .premium-alerts-section { background:#fff; padding:30px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,.1); margin:30px 0; }
        .premium-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; }
        .card { background:#fff; border:1px solid #eaeaea; border-radius:12px; padding:16px; box-shadow:0 6px 16px rgba(0,0,0,.06); }
        .badge { padding:4px 8px; border-radius:8px; font-size:.8rem; font-weight:600; }
        .badge-green { background:#e6f8ee; color:#16794d; }
        .badge-orange { background:#fff2e0; color:#b65a00; }
        .badge-gray { background:#f1f3f5; color:#555; }
        .muted { color:#6b7280; font-size:.9rem; }

        /* Live Trip Counter (vanilla) */
        .ltc-section { background:#0b1220; color:#eef2ff; padding:24px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); margin:30px 0; }
        .ltc-controls { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:16px 0; }
        .ltc-btn { border:none; border-radius:12px; padding:12px 18px; font-weight:600; cursor:pointer; color:#fff; transition:transform .1s ease; }
        .ltc-btn:hover { transform: translateY(-1px); }
        .ltc-btn-green{ background:#22c55e; } .ltc-btn-yellow{ background:#f59e0b; } .ltc-btn-red{ background:#ef4444; }
        .ltc-platforms{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:10px; }
        .ltc-chip{ padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.08); cursor:pointer; }
        .ltc-chip.active{ box-shadow:0 0 0 2px rgba(255,255,255,.25) inset; transform: translateY(-1px); }
        .ltc-timer{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; font-size:48px; text-align:center; margin:10px 0; background: linear-gradient(90deg,#60a5fa,#a78bfa); -webkit-background-clip:text; background-clip:text; color:transparent; }
        .ltc-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; }
        .ltc-card{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); border-radius:14px; padding:12px; text-align:center; }

        /* Modo Challenge (vanilla) */
        .challenge-section{ background:#0f172a; color:#eef2ff; padding:24px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); margin:30px 0; }
        .ch-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:14px; }
        .ch-card{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:16px; }
        .ch-badge{ padding:6px 10px; border-radius:999px; font-weight:700; font-size:.8rem; }
        .ch-progress{ height:16px; background:#334155; border-radius:999px; overflow:hidden; }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">🚗</div>
        <div class="loading-text">Cargando DriveMetrics...</div>
        <div class="spinner"></div>
    </div>

    <div class="login-container hidden" id="loginContainer">
        <div class="login-box">
            <div class="logo">🚗</div>
            <h1 class="title">DriveMetrics</h1>
            <p class="subtitle">Inicia sesión para acceder a tu dashboard de métricas de conducción</p>
            <button class="google-btn" id="googleLoginBtn" onclick="iniciarGoogleAuth()">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar con Google
            </button>
            <div class="message error-message" id="errorMessage"></div>
            <div class="message success-message" id="successMessage"></div>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="dashboard-header">
            <div class="user-info">
                <img class="user-avatar" id="userAvatar" src="" alt="Avatar">
                <div class="user-details">
                    <h3 id="userName">Cargando...</h3>
                    <p id="userEmail">Cargando...</p>
                </div>
            </div>
            <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesión</button>
        </div>
        <div class="dashboard-content">
            <div class="welcome-section">
                <h1>¡Bienvenido a DriveMetrics!</h1>
                <p>Tu dashboard personalizado está listo. Sesión iniciada correctamente.</p>
            </div>

            <!-- Calculadora principal (estructura base) -->
            <div class="container" id="calcRoot">
        <div class="header">
            <h1>🚗💰 Calculadora de Ganancias</h1>
            <p>Uber • Rappi • Pedidos Ya • Argentina</p>
        </div>

        <div class="calculator-container">
            <!-- SECCIÓN DE INPUTS -->
            <div class="input-section">
                <h2 class="section-title">📊 Datos de Trabajo</h2>
                
                <div class="platform-selector" id="platformSelector">
                    <button class="platform-btn active" data-platform="uber">🚗 Uber</button>
                    <button class="platform-btn" data-platform="didi">🚖 DiDi</button>
                    <button class="platform-btn" data-platform="rappi">🛵 Rappi</button>
                    <button class="platform-btn" data-platform="pedidosya">🍕 PedidosYa</button>
                </div>

                <div class="input-group">
                    <label>💵 Ganancia Bruta (por día)</label>
                    <input type="number" id="ganancia-bruta" placeholder="8000" value="8000">
                </div>

                <div class="input-group">
                    <label>⏰ Horas trabajadas (por día)</label>
                    <input type="number" id="horas-dia" placeholder="8" value="8">
                </div>

                <div class="input-group">
                    <label>🏢 Días trabajados (por semana)</label>
                    <input type="number" id="dias-semana" placeholder="6" value="6">
                </div>

                <div class="input-group">
                    <label>⛽ Km recorridos (por día)</label>
                    <input type="number" id="km-dia" placeholder="150" value="150">
                </div>

                <div class="input-group">
                    <label>🚗 Consumo del auto (km/litro)</label>
                    <input type="number" id="consumo-auto" placeholder="12" value="12">
                </div>

                <div class="input-group">
                    <label>⛽ Precio nafta (por litro)</label>
                    <input type="number" id="precio-nafta" placeholder="850" value="850">
                </div>

                <div class="input-group">
                    <label>🔧 Gastos adicionales (por día)</label>
                    <input type="number" id="gastos-adicionales" placeholder="500" value="500">
                </div>

                <button class="calculate-btn" onclick="calcular()">
                    🧮 CALCULAR GANANCIAS REALES
                </button>
            </div>

            <!-- SECCIÓN DE RESULTADOS -->
            <div class="results-section">
                <h2 class="section-title">💰 Tus Ganancias Reales</h2>
                
                <div class="result-card">
                    <div class="result-title">Ganancia por hora</div>
                    <div class="result-value" id="ganancia-hora">$0</div>
                </div>

                <div class="result-card">
                    <div class="result-title">Ganancia diaria NETA</div>
                    <div class="result-value" id="ganancia-dia">$0</div>
                </div>

                <div class="result-card">
                    <div class="result-title">Ganancia semanal</div>
                    <div class="result-value" id="ganancia-semana">$0</div>
                </div>

                <div class="result-card">
                    <div class="result-title">Ganancia mensual</div>
                    <div class="result-value" id="ganancia-mes">$0</div>
                </div>

                <div class="result-card">
                    <div class="result-title">Gastos totales por día</div>
                    <div class="result-value" id="gastos-totales">$0</div>
                </div>
            </div>
        </div>

        <!-- RECOMENDACIONES -->
        <div class="recommendations">
            <h2 class="section-title">💡 Recomendaciones Personalizadas</h2>
            <div id="recomendaciones-content">
                <p>Completa los datos arriba para ver tus recomendaciones personalizadas</p>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="export-btn" onclick="exportarPDF()">📄 Exportar PDF</button>
                <button class="export-btn" onclick="compartir()">📱 Compartir Resultados</button>
            </div>
        </div>

        <!-- SECCIÓN PREDICTOR IA -->
        <div class="predictor-ia-section">
            <h2 class="section-title">🤖 Predictor IA Premium</h2>
            <div class="predictor-container">
                <div class="prediccion-card">
                    <div class="ia-icon">🚀</div>
                    <h3>Optimización Automática</h3>
                    <div id="prediccion-optimizacion" class="prediccion-content">Analizando tus datos...</div>
                </div>
                <div class="prediccion-card">
                    <div class="ia-icon">📊</div>
                    <h3>Comparación Inteligente</h3>
                    <div id="prediccion-comparacion" class="prediccion-content">Calculando mejores opciones...</div>
                </div>
                <div class="prediccion-card">
                    <div class="ia-icon">💰</div>
                    <h3>Potencial de Crecimiento</h3>
                    <div id="prediccion-crecimiento" class="prediccion-content">Evaluando oportunidades...</div>
                </div>
                <div class="prediccion-card full-width">
                    <div class="ia-icon">🎯</div>
                    <h3>Plan de Acción Personalizado</h3>
                    <div id="plan-accion" class="prediccion-content">Generando estrategia óptima...</div>
                </div>
            </div>
        </div>

        <!-- MAPA DE CALOR DE GANANCIAS -->
        <div class="mapa-calor-section">
            <h2 class="section-title">📍 Mapa de Calor - Zonas Premium</h2>
            <div class="ubicacion-detector">
                <button id="detectar-ubicacion" class="detectar-btn">📍 Detectar Mi Ubicación</button>
                <div id="ubicacion-actual" class="ubicacion-info hidden">
                    <strong>Tu ubicación:</strong> <span id="ciudad-detectada"></span>
                </div>
            </div>
            <div class="mapa-container">
                <div class="zona-actual-card">
                    <h3>📌 Tu Zona Actual</h3>
                    <div id="analisis-zona-actual"><p>Detecta tu ubicación para análisis personalizado</p></div>
                </div>
                <div class="zonas-premium-card">
                    <h3>🔥 Zonas Premium de Tu Ciudad</h3>
                    <div id="zonas-premium-list"><p>Cargando zonas...</p></div>
                </div>
                <div class="comparacion-zonas">
                    <h3>⚡ Comparación de Ganancias</h3>
                    <div id="comparacion-ganancias-zonas"></div>
                </div>
                <div class="horarios-zona">
                    <h3>⏰ Mejores Horarios por Zona</h3>
                    <div id="horarios-optimizados"></div>
                </div>
            </div>
        </div>

        <!-- ALERTAS DE HORARIOS PREMIUM (versión web simple) -->
        <div class="premium-alerts-section">
            <h2 class="section-title">🔔 Alertas de Horarios Premium</h2>
            <div id="premium-alerts-root">
                <div class="card">
                    <div class="muted">Estado actual</div>
                    <div id="premium-estado-actual" style="margin-top:8px;">Sin horarios premium activos</div>
                </div>
                <div class="card" style="margin-top:12px;">
                    <div class="muted">Próximo horario premium</div>
                    <div id="premium-proximo" style="margin-top:8px;">Calculando...</div>
                </div>
                <div class="card" style="margin-top:12px;">
                    <div class="muted">Historial de alertas</div>
                    <div id="premium-historial" style="margin-top:8px; font-size:.9rem; color:#374151;">—</div>
                </div>
            </div>
        </div>

        <!-- CONTADOR DE VIAJES EN VIVO (versión web simple) -->
        <div class="ltc-section" id="ltc">
            <h2 class="section-title">🚦 Contador de Viajes EN VIVO</h2>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; background:rgba(255,255,255,.08); padding:12px 16px; border-radius:12px;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="ltc-indicator" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#6b7280;"></span>
                    <span id="ltc-status" class="muted">INACTIVO</span>
                </div>
                <div class="ltc-controls">
                    <button class="ltc-btn ltc-btn-green" id="ltc-start">INICIAR SESIÓN</button>
                    <button class="ltc-btn ltc-btn-yellow" id="ltc-pause">PAUSAR</button>
                    <button class="ltc-btn ltc-btn-red" id="ltc-stop">FINALIZAR</button>
                </div>
            </div>
            <div class="ltc-platforms" id="ltc-platforms"></div>
            <div class="ltc-timer" id="ltc-worktime">00:00:00</div>

            <div class="ltc-card" style="margin:10px 0;">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <div style="font-weight:700;">Viaje Actual</div>
                        <div id="ltc-trip-status" class="muted">Esperando</div>
                    </div>
                    <div>
                        <button class="ltc-btn ltc-btn-green" id="ltc-trip-start">INICIAR VIAJE</button>
                        <button class="ltc-btn ltc-btn-green" id="ltc-trip-complete" style="background:#16a34a;">COMPLETAR</button>
                    </div>
                </div>
                <div class="ltc-grid" style="margin-top:10px;">
                    <div class="ltc-card"><div id="ltc-trip-duration">00:00:00</div><div class="muted">Duración</div></div>
                    <div class="ltc-card"><div id="ltc-trip-distance">0.0 km</div><div class="muted">Distancia</div></div>
                    <div class="ltc-card"><div id="ltc-trip-earning">$0</div><div class="muted">Estimado</div></div>
                    <div class="ltc-card"><div id="ltc-trip-platform">Uber</div><div class="muted">Plataforma</div></div>
                </div>
            </div>

            <div class="ltc-grid">
                <div class="ltc-card"><div id="ltc-d-trips">0</div><div class="muted">Viajes Completados</div></div>
                <div class="ltc-card"><div id="ltc-d-earnings">$0</div><div class="muted">Ganancias Totales</div></div>
                <div class="ltc-card"><div id="ltc-d-avg">$0</div><div class="muted">Promedio por Viaje</div></div>
                <div class="ltc-card"><div id="ltc-d-hours">0.0h</div><div class="muted">Horas Trabajadas</div></div>
            </div>
        </div>

        <!-- DATOS REALES (versión web simple) -->
        <div class="rd-section" id="realdata">
            <h2 class="section-title">🛰️ Datos Reales</h2>
            <div class="rd-card" style="margin-bottom:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span>Estado</span>
                        <span id="rd-online" class="rd-pill" style="background:rgba(34,197,94,.2); color:#22c55e;">Online</span>
                    </div>
                    <button id="rd-refresh" class="ltc-btn ltc-btn-green">Actualizar</button>
                </div>
                <div style="margin-top:10px;">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span>Ubicación:</span>
                        <span id="rd-location" class="muted">Detectando...</span>
                        <button id="rd-retry" class="ltc-btn ltc-btn-yellow">Reintentar</button>
                    </div>
                    <div id="rd-location-geo" class="muted" style="margin-top:6px;">—</div>
                </div>
            </div>
            <div class="rd-grid" id="rd-platforms"></div>
            <div class="rd-card" id="rd-recs" style="margin-top:12px;"></div>
            <div class="rd-card" id="rd-hotzones" style="margin-top:12px;"></div>
        </div>

        <!-- MODO CHALLENGE (versión web simple) -->
        <div class="challenge-section" id="challenge">
            <h2 class="section-title">🏆 MODO CHALLENGE</h2>
            <div style="text-align:center; margin-bottom:10px;">Superá tus límites y ganá puntos</div>
            <div style="text-align:center; margin:12px 0;">
                <button id="ch-start" class="ltc-btn ltc-btn-green">INICIAR</button>
                <button id="ch-pause" class="ltc-btn ltc-btn-yellow">PAUSAR</button>
                <button id="ch-reset" class="ltc-btn ltc-btn-red">REINICIAR</button>
            </div>
            <div class="ch-card" style="margin-bottom:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:800; font-size:20px;" id="ch-active-name">—</div>
                        <div class="muted" id="ch-active-desc">Seleccioná un desafío para comenzar</div>
                    </div>
                    <div class="ch-badge" id="ch-reward" style="background:#f59e0b; color:#1f2937;">0 pts</div>
                </div>
                <div style="margin-top:12px;">
                    <div style="display:flex; justify-content:space-between;">
                        <span>Progreso</span>
                        <span id="ch-progress-text">0%</span>
                    </div>
                    <div class="ch-progress"><div id="ch-progress-bar"></div></div>
                </div>
                <div class="ch-grid" style="margin-top:12px;">
                    <div class="ch-card"><div id="ch-earn">$0</div><div class="muted">Ganancias</div></div>
                    <div class="ch-card"><div id="ch-trips">0</div><div class="muted">Viajes</div></div>
                    <div class="ch-card"><div id="ch-time">00:00:00</div><div class="muted">Tiempo</div></div>
                    <div class="ch-card"><div id="ch-zones">0</div><div class="muted">Zonas</div></div>
                </div>
            </div>
            <div class="ch-card" style="margin-bottom:12px;">
                <h3 style="margin:0 0 10px 0">Seleccioná dificultad</h3>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="ltc-btn" id="ch-diff-easy" style="background:#22c55e;">FÁCIL</button>
                    <button class="ltc-btn" id="ch-diff-medium" style="background:#f59e0b;">MEDIO</button>
                    <button class="ltc-btn" id="ch-diff-hard" style="background:#ef4444;">DIFÍCIL</button>
                </div>
            </div>
            <div class="ch-card">
                <h3 style="margin:0 0 8px 0">Desafíos Disponibles</h3>
                <div id="ch-list" class="ch-grid"></div>
            </div>
        </div>

        <!-- FOOTER DE VENTA -->
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center; color: white;">
            <h3>🚀 ¿Te sirvió esta calculadora?</h3>
            <p>Ayuda a otros drivers compartiendo esta herramienta</p>
            <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
                Desarrollado por un argentino para argentinos 🇦🇷
            </p>
        </div>
    </div>
        </div>
    </div>

    <script src="/quickImplementation.js"></script>
    <script src="/payment-system.js"></script>
    <script>window.paymentSystem = new PaymentSystem();</script>
    <script src="/trial-counter.js"></script>
    <script>
        const GOOGLE_CLIENT_ID = '151117015962-qhq4at3nbja8q9rq7qvspcc0sunr113u.apps.googleusercontent.com';
        const firebaseConfig = {
            apiKey: 'AIzaSyCFDb40oDXxQRG4PY0GAIaC8Ck7zS9tm0A',
            authDomain: 'drivemetrics-9ef78.firebaseapp.com',
            projectId: 'drivemetrics-9ef78',
            storageBucket: 'drivemetrics-9ef78.firebasestorage.app',
            messagingSenderId: '151117015962',
            appId: '1:151117015962:web:576aff049892be2760e823'
        };
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async function() {
            mostrarPantalla('loading');
            try {
                await new Promise(r => setTimeout(r, 600));
                if (window.firebase && !firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const sesion = await verificarSesionExistente();
                if (sesion) {
                    await mostrarDashboard(sesion);
                } else {
                    const redirectHecho = await procesarRedirectResult();
                    if (!redirectHecho) mostrarPantalla('login');
                }
                // Inicializar simulador de datos reales (opcional)
                try {
                    if (window.RealDataSimulator) {
                        window.__rdSim = new RealDataSimulator();
                        await window.__rdSim.getCurrentLocation();
                        const d = window.__rdSim.generateRealtimeData();
                        // se podría hidratar UI aquí con d
                        window.__rdSim.startRealTimeUpdates(()=>{});
                    }
                } catch {}
            } catch(e) {
                console.error(e); mostrarPantalla('login');
            }
        });

        async function iniciarGoogleAuth(){
            const btn = document.getElementById('googleLoginBtn');
            try{
                btn.disabled = true; btn.textContent = 'Iniciando...';
                if (window.firebase && firebase.auth){
                    const auth = firebase.auth();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email'); provider.addScope('profile'); provider.setCustomParameters({ prompt: 'select_account' });
                    try{
                        const result = await auth.signInWithPopup(provider);
                        await manejarAutenticacionExitosa(result.user);
                    }catch(err){
                        if (err.code === 'auth/popup-blocked') { await auth.signInWithRedirect(provider); }
                        else { throw err; }
                    }
                } else { throw new Error('Firebase no está disponible'); }
            }catch(err){ manejarErrorLogin(err); }
            finally{ btn.disabled = false; btn.textContent = 'Continuar con Google'; }
        }

        async function procesarRedirectResult(){
            if (!(window.firebase && firebase.auth)) return false;
            try{
                const result = await firebase.auth().getRedirectResult();
                if (result && result.user){ await manejarAutenticacionExitosa(result.user); return true; }
            }catch(err){ manejarErrorLogin(err); }
            return false;
        }

        async function verificarSesionExistente(){
            const saved = localStorage.getItem('drivemetrics_user');
            if (saved){ try { return JSON.parse(saved); } catch{ localStorage.removeItem('drivemetrics_user'); } }
            if (window.firebase && firebase.auth){
                return new Promise((resolve)=>{
                    const unsub = firebase.auth().onAuthStateChanged((user)=>{
                        unsub(); resolve(user ? { id:user.uid, email:user.email, name:user.displayName, picture:user.photoURL, provider:'google' } : null);
                    });
                });
            }
            return null;
        }

        async function manejarAutenticacionExitosa(user){
            const userData = { id:user.uid, email:user.email, name:user.displayName, picture:user.photoURL, provider:'google', loginTime:new Date().toISOString() };
            localStorage.setItem('drivemetrics_user', JSON.stringify(userData));
            currentUser = userData; await mostrarDashboard(userData);
        }

        async function mostrarDashboard(userData){
            document.getElementById('userAvatar').src = userData.picture || 'https://via.placeholder.com/50';
            document.getElementById('userName').textContent = userData.name || 'Usuario';
            document.getElementById('userEmail').textContent = userData.email || '';
            document.getElementById('dashboardUserName') && (document.getElementById('dashboardUserName').textContent = userData.name || 'Usuario');
            mostrarPantalla('dashboard');

            // Enlazar eventos básicos de la calculadora
            const btn = document.getElementById('btnCalcular');
            if (btn && !btn._bound) {
                btn.addEventListener('click', () => {
                    // Placeholder: cálculo mínimo de demostración
                    const netoDia = 0;
                    const netoHora = 0;
                    document.getElementById('resNetoDia').textContent = `$ ${netoDia.toFixed(2)}`;
                    document.getElementById('resNetoHora').textContent = `$ ${netoHora.toFixed(2)}`;
                });
                btn._bound = true;
            }
        }

        async function cerrarSesion(){
            try{ if (window.firebase && firebase.auth) await firebase.auth().signOut(); }catch{}
            localStorage.removeItem('drivemetrics_user'); currentUser=null; mostrarPantalla('login');
        }

        function mostrarPantalla(tipo){
            const loading = document.getElementById('loadingScreen');
            const login = document.getElementById('loginContainer');
            const dash = document.getElementById('dashboard');
            loading.classList.add('hidden'); login.classList.add('hidden'); dash.classList.remove('active');
            if (tipo==='loading') loading.classList.remove('hidden');
            if (tipo==='login') login.classList.remove('hidden');
            if (tipo==='dashboard') dash.classList.add('active');
        }

        function manejarErrorLogin(error){
            console.error('Login error', error);
            let m='Error al iniciar sesión';
            if(error.code==='auth/unauthorized-domain') m='Dominio no autorizado en Firebase';
            if(error.code==='auth/popup-blocked') m='Popup bloqueado: permita popups o use redirect';
            mostrarError(m);
        }
        function mostrarError(m){ const el=document.getElementById('errorMessage'); if(el){ el.textContent=m; el.style.display='block'; setTimeout(()=>el.style.display='none',5000);} }
        function mostrarExito(m){ const el=document.getElementById('successMessage'); if(el){ el.textContent=m; el.style.display='block'; setTimeout(()=>el.style.display='none',3000);} }

        // Lógica con datos por plataforma y recomendaciones
        let plataformaSeleccionada = 'uber';
        const plataformasData = {
            uber: {
                comision: 0.25,
                nombre: 'Uber',
                horariosPico: ['7-9', '12-14', '19-22'],
                consejos: [
                    'Trabaja en horarios pico para maximizar ganancias',
                    'Evita zonas con mucho tráfico en horas punta',
                    'Mantén el auto limpio para mejor rating'
                ]
            },
            didi: {
                comision: 0.20,
                nombre: 'DiDi',
                horariosPico: ['7-9', '12-14', '18-21'],
                consejos: [
                    'DiDi tiene menos comisión que Uber (20% vs 25%)',
                    'Acepta viajes largos, DiDi paga mejor distancia',
                    'Mantén 4.8+ de rating para recibir más viajes',
                    'Los martes y miércoles suelen tener bonos extras'
                ]
            },
            rappi: {
                comision: 0.15,
                nombre: 'Rappi',
                horariosPico: ['12-15', '19-23'],
                consejos: [
                    'Acepta pedidos múltiples cuando sea posible',
                    'Posiciónate cerca de restaurantes populares',
                    'Los fines de semana son más rentables'
                ]
            },
            pedidosya: {
                comision: 0.18,
                nombre: 'PedidosYa',
                horariosPico: ['12-14', '20-22'],
                consejos: [
                    'Mantén un buen puntaje para recibir más pedidos',
                    'Conoce bien tu zona para ser más rápido',
                    'Las lluvias aumentan la demanda'
                ]
            }
        };

        // Selección de plataforma
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.platform-btn');
            if (!btn) return;
            document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            plataformaSeleccionada = btn.getAttribute('data-platform');
            calcular();
        });

        function calcular() {
            const gananciaBruta = parseFloat(document.getElementById('ganancia-bruta').value) || 0;
            const horasDia = parseFloat(document.getElementById('horas-dia').value) || 1;
            const diasSemana = parseFloat(document.getElementById('dias-semana').value) || 1;
            const kmDia = parseFloat(document.getElementById('km-dia').value) || 0;
            const consumoAuto = parseFloat(document.getElementById('consumo-auto').value) || 1;
            const precioNafta = parseFloat(document.getElementById('precio-nafta').value) || 0;
            const gastosAdicionales = parseFloat(document.getElementById('gastos-adicionales').value) || 0;

            const plataforma = plataformasData[plataformaSeleccionada];
            const comisionPlataforma = gananciaBruta * plataforma.comision;
            const litrosConsumidos = kmDia / consumoAuto;
            const gastoNafta = litrosConsumidos * precioNafta;
            const gastosTotalesDia = gastoNafta + gastosAdicionales + comisionPlataforma;
            
            const gananciaNeta = gananciaBruta - gastosTotalesDia;
            const gananciaHora = gananciaNeta / horasDia;
            const gananciaSemana = gananciaNeta * diasSemana;
            const gananciaMes = gananciaSemana * 4.33;

            document.getElementById('ganancia-hora').textContent = `$${gananciaHora.toFixed(0)}`;
            document.getElementById('ganancia-dia').textContent = `$${gananciaNeta.toFixed(0)}`;
            document.getElementById('ganancia-semana').textContent = `$${gananciaSemana.toFixed(0)}`;
            document.getElementById('ganancia-mes').textContent = `$${gananciaMes.toFixed(0)}`;
            document.getElementById('gastos-totales').textContent = `$${gastosTotalesDia.toFixed(0)}`;

            generarRecomendaciones(gananciaHora, gananciaNeta, gastosTotalesDia, gananciaBruta);
        }

        function generarRecomendaciones(gananciaHora, gananciaNeta, gastos, gananciaBruta) {
            const plataforma = plataformasData[plataformaSeleccionada];
            let recomendaciones = `<h3>📈 Análisis para ${plataforma.nombre}</h3>`;
            if (gananciaHora > 1000) {
                recomendaciones += `<p>✅ <strong>Excelente:</strong> Ganás $${gananciaHora.toFixed(0)} por hora. ¡Mantené este ritmo!</p>`;
            } else if (gananciaHora > 600) {
                recomendaciones += `<p>⚠️ <strong>Aceptable:</strong> Ganás $${gananciaHora.toFixed(0)} por hora. Podés mejorar optimizando rutas.</p>`;
            } else {
                recomendaciones += `<p>🚨 <strong>Mejorable:</strong> Ganás solo $${gananciaHora.toFixed(0)} por hora. Necesitás optimizar urgente.</p>`;
            }
            const porcentajeGastos = (gastos / gananciaBruta) * 100;
            recomendaciones += `<p><strong>Gastos:</strong> ${isFinite(porcentajeGastos) ? porcentajeGastos.toFixed(1) : 0}% de tu ganancia bruta.</p>`;
            if (porcentajeGastos > 60) recomendaciones += `<p>🚨 Tus gastos son muy altos. Considerá cambiar de auto o zona.</p>`;
            recomendaciones += `<h4>⏰ Horarios más rentables:</h4><p>${plataforma.horariosPico.join(', ')}hs</p>`;
            recomendaciones += `<h4>💡 Consejos para ${plataforma.nombre}:</h4><ul>` + plataforma.consejos.map(c=>`<li>${c}</li>`).join('') + `</ul>`;
            const proyeccionAnual = gananciaNeta * 365;
            recomendaciones += `<h4>🎯 Proyección anual: $${isFinite(proyeccionAnual)? proyeccionAnual.toLocaleString() : 0}</h4>`;
            document.getElementById('recomendaciones-content').innerHTML = recomendaciones;
            // Actualizar predictor IA en cada cálculo
            generarPrediccionesIA(gananciaHora, gananciaNeta, gastos, gananciaBruta, parseFloat(document.getElementById('horas-dia').value) || 1, parseFloat(document.getElementById('dias-semana').value) || 1);
        }

        // Motor de predicciones IA
        function generarPrediccionesIA(gananciaHora, gananciaNeta, gastos, gananciaBruta, horasDia, diasSemana) {
            const plataforma = plataformasData[plataformaSeleccionada];
            const optimizacion = analizarOptimizacion(gananciaHora, gananciaNeta, horasDia, diasSemana);
            document.getElementById('prediccion-optimizacion').innerHTML = optimizacion;
            const comparacion = compararPlataformas(gananciaBruta, gastos);
            document.getElementById('prediccion-comparacion').innerHTML = comparacion;
            const crecimiento = calcularCrecimiento(gananciaNeta, horasDia, diasSemana);
            document.getElementById('prediccion-crecimiento').innerHTML = crecimiento;
            const planAccion = generarPlanAccion(gananciaHora, plataforma.nombre, horasDia);
            document.getElementById('plan-accion').innerHTML = planAccion;
        }

        function analizarOptimizacion(gananciaHora, gananciaNeta, horasDia, diasSemana) {
            let optimizacion = '';
            if (gananciaHora < 800) {
                optimizacion += `🚨 <span class="prediccion-highlight">Alerta:</span> Tu ganancia por hora está ${((800-gananciaHora)/800*100).toFixed(0)}% por debajo del promedio.<br><br>`;
                optimizacion += `💡 <strong>Recomendación IA:</strong> Cambiá tu horario al rango 18:30-22:30 para aumentar ganancias en <span class=\"prediccion-numero\">+$${(gananciaHora * 0.4).toFixed(0)}/hora</span>`;
            } else if (gananciaHora > 1200) {
                optimizacion += `✅ <span class="prediccion-highlight">Excelente performance!</span><br><br>`;
                optimizacion += `🚀 <strong>Oportunidad:</strong> Si mantenés este ritmo y agregás 1 día más, ganarías <span class=\"prediccion-numero\">+$${(gananciaNeta * 4.33).toFixed(0)}</span> extra al mes`;
            } else {
                optimizacion += `⚡ <strong>Potencial detectado:</strong> Aumentando eficiencia en 15% ganarías <span class=\"prediccion-numero\">+$${(gananciaHora * 0.15 * horasDia * diasSemana * 4.33).toFixed(0)}</span> mensual adicional<br><br>`;
                optimizacion += `🎯 Focalizá en: Horarios pico + Zonas premium + Rechazar viajes cortos`;
            }
            return optimizacion;
        }

        function compararPlataformas(gananciaBruta, gastos) {
            const plataformas = ['uber', 'didi', 'rappi', 'pedidosya'];
            let mejorOpcion = '';
            let maxGanancia = 0;
            let comparaciones = '<div style="margin-bottom: 15px;"><strong>Si trabajaras hoy en:</strong></div>';
            plataformas.forEach(plat => {
                const data = plataformasData[plat];
                const comision = gananciaBruta * data.comision;
                const gananciaReal = gananciaBruta - comision - gastos;
                comparaciones += `<div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>${data.nombre}:</span><span class=\"prediccion-numero\">$${gananciaReal.toFixed(0)}</span></div>`;
                if (gananciaReal > maxGanancia) { maxGanancia = gananciaReal; mejorOpcion = data.nombre; }
            });
            const actual = gananciaBruta - (gananciaBruta * plataformasData[plataformaSeleccionada].comision) - gastos;
            const diferencia = maxGanancia - actual;
            if (diferencia > 0) {
                comparaciones += `<br><div style="background: rgba(255,215,0,0.2); padding:10px; border-radius:5px; border-left:3px solid #ffd700;">🎯 <strong>Recomendación:</strong> ${mejorOpcion} te conviene <span class=\"prediccion-numero\">$${diferencia.toFixed(0)} más</span> por día</div>`;
            } else {
                comparaciones += `<br><div style="background: rgba(0,255,136,0.2); padding:10px; border-radius:5px;">✅ Ya estás usando la plataforma más rentable</div>`;
            }
            return comparaciones;
        }

        function calcularCrecimiento(gananciaNeta, horasDia, diasSemana) {
            const escenarios = [
                { titulo: "+2 horas diarias", calculo: (gananciaNeta / horasDia * 2 * diasSemana * 4.33).toFixed(0), descripcion: "Manteniendo mismo ritmo" },
                { titulo: "+1 día semanal", calculo: (gananciaNeta * 4.33).toFixed(0), descripcion: "Agregando fines de semana" },
                { titulo: "Optimización total", calculo: (gananciaNeta * 1.35 * diasSemana * 4.33).toFixed(0), descripcion: "Horarios + zonas premium" }
            ];
            return escenarios.map(e => `<div style=\"margin-bottom:12px; padding:10px; background: rgba(255,255,255,0.05); border-radius:5px;\"><div style=\"font-weight:bold;\">${e.titulo}</div><div style=\"color:#00ff88; font-size:1.1rem;\">+$${e.calculo} mensual</div><div style=\"font-size:.9rem; opacity:.8;\">${e.descripcion}</div></div>`).join('');
        }

        function generarPlanAccion(gananciaHora, plataforma, horasDia) {
            let plan = '<div style="text-align:left;">';
            plan += `<div style=\"margin-bottom:15px;\"><strong>🎯 Tu plan optimizado para ${plataforma}:</strong></div>`;
            if (gananciaHora < 800) {
                plan += `
        <div style=\"margin-bottom:10px;\">📍 <strong>1. Cambiar zonas:</strong> Movete a Palermo, Belgrano o Puerto Madero</div>
        <div style=\"margin-bottom:10px;\">⏰ <strong>2. Horarios premium:</strong> 7-9hs, 12-14hs, 18:30-22:30hs</div>
        <div style=\"margin-bottom:10px;\">🚫 <strong>3. Filtrar viajes:</strong> Rechazar distancias menores a 1.5km</div>
        <div style=\"margin-bottom:10px;\">💰 <strong>Resultado esperado:</strong> <span class=\"prediccion-numero\">+$400/hora</span></div>
        `;
            } else {
                plan += `
        <div style=\"margin-bottom:10px;\">✅ <strong>1. Mantener rutina:</strong> Tu estrategia actual funciona</div>
        <div style=\"margin-bottom:10px;\">📈 <strong>2. Escalar:</strong> Agregar 1-2 horas en horarios pico</div>
        <div style=\"margin-bottom:10px;\">🎯 <strong>3. Optimizar:</strong> Usar múltiples apps simultáneamente</div>
        <div style=\"margin-bottom:10px;\">💎 <strong>Potencial:</strong> <span class=\"prediccion-numero\">+$15,000/mes</span></div>
        `;
            }
            plan += '</div>'; return plan;
        }

        function exportarPDF() {
            const resultados = {
                plataforma: plataformasData[plataformaSeleccionada].nombre,
                gananciaHora: document.getElementById('ganancia-hora').textContent,
                gananciaDia: document.getElementById('ganancia-dia').textContent,
                gananciaSemana: document.getElementById('ganancia-semana').textContent,
                gananciaMes: document.getElementById('ganancia-mes').textContent
            };
            const contenido = `\nREPORTE DE GANANCIAS - ${resultados.plataforma}\n=====================================\n\nGanancia por hora: ${resultados.gananciaHora}\nGanancia diaria: ${resultados.gananciaDia}  \nGanancia semanal: ${resultados.gananciaSemana}\nGanancia mensual: ${resultados.gananciaMes}\n\nFecha: ${new Date().toLocaleDateString('es-AR')}\nCalculadora: drivemetrics.vercel.app\n`;
            const blob = new Blob([contenido], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `reporte-ganancias-${plataformasData[plataformaSeleccionada].nombre.toLowerCase()}.txt`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            alert('📄 Reporte descargado!');
        }

        function compartir() {
            const resultados = `🚗💰 Mis ganancias reales en ${plataformasData[plataformaSeleccionada].nombre}:\n\nPor hora: ${document.getElementById('ganancia-hora').textContent}\nPor día: ${document.getElementById('ganancia-dia').textContent}\nPor mes: ${document.getElementById('ganancia-mes').textContent}\n\nCalculá las tuyas en: drivemetrics.vercel.app`;
            if (navigator.share) {
                navigator.share({ title: 'Calculadora de Ganancias DriveMetrics', text: resultados });
            } else {
                navigator.clipboard.writeText(resultados); alert('📱 Resultados copiados!');
            }
        }

        // Cálculo automático
        document.addEventListener('input', (e)=>{
            if (e.target.matches('input')) { if (document.getElementById('ganancia-bruta').value) calcular(); }
        });
        window.addEventListener('load', ()=> setTimeout(calcular, 500));

        // === Alertas de horarios premium (sin React) ===
        const premiumSchedules = [
            { id:'morning-rush', name:'Hora Pico Matutina', startTime:'07:00', endTime:'09:30', zones:['Centro','Zona Financiera','Universidades'], multiplier:1.5, description:'Mayor demanda de viajes al trabajo y universidades' },
            { id:'lunch-time', name:'Hora de Almuerzo', startTime:'12:00', endTime:'14:00', zones:['Centro','Zona Comercial','Restaurantes'], multiplier:1.3, description:'Alta demanda en zonas de restaurantes y comercio' },
            { id:'evening-rush', name:'Hora Pico Vespertina', startTime:'17:30', endTime:'20:00', zones:['Centro','Zona Residencial','Centros Comerciales'], multiplier:1.6, description:'Regreso a casa y actividades nocturnas' },
            { id:'weekend-night', name:'Noche de Fin de Semana', startTime:'21:00', endTime:'03:00', zones:['Zona de Bares','Centro de Entretenimiento'], multiplier:1.8, description:'Alta demanda en zonas de entretenimiento nocturno', weekendOnly:true }
        ];

        let premiumAlerts = [];

        function checkPremiumTime(){
            const now=new Date(); const isWeekend = now.getDay()===0 || now.getDay()===6;
            const hh=now.getHours(); const mm=now.getMinutes();
            const active=[]; const newAlerts=[];
            for(const s of premiumSchedules){
                if(s.weekendOnly && !isWeekend) continue;
                const [sh, sm]=s.startTime.split(':').map(Number); const [eh, em]=s.endTime.split(':').map(Number);
                let inRange=false;
                if (eh < sh) {
                    inRange = (hh>sh || (hh===sh && mm>=sm)) || (hh<eh || (hh===eh && mm<=em));
                } else {
                    inRange = (hh>sh || (hh===sh && mm>=sm)) && (hh<eh || (hh===eh && mm<=em));
                }
                if (inRange) active.push(s);
                const alertDate=new Date(now); alertDate.setHours(sh, sm-15, 0, 0);
                if (Math.abs(now - alertDate) < 60000) newAlerts.push({ id:`alert-${s.id}-${Date.now()}`, schedule:s, message:'¡Horario Premium iniciando en 15 minutos!', timestamp:now });
            }
            premiumAlerts = [...premiumAlerts, ...newAlerts].slice(-10);
            renderPremium(active);
        }

        function renderPremium(active){
            const estado = document.getElementById('premium-estado-actual');
            const proximo = document.getElementById('premium-proximo');
            const historial = document.getElementById('premium-historial');
            if(estado){
                estado.innerHTML = active.length? active.map(s=>`<div style=\"display:flex; justify-content:space-between;\"><div><strong>${s.name}</strong><div class=\"muted\">${s.description}</div><div class=\"muted\">${s.startTime} - ${s.endTime}</div></div><span class=\"badge badge-green\">+${((s.multiplier-1)*100).toFixed(0)}%</span></div>`).join('<hr style=\"border:none; border-top:1px solid #eee; margin:8px 0;\">') : 'Sin horarios premium activos';
            }
            if(proximo){
                const next = getNextPremiumSchedule();
                proximo.innerHTML = next? `<div style=\"display:flex; justify-content:space-between;\"><div><strong>${next.name}</strong><div class=\"muted\">${next.description}</div><div class=\"muted\">${next.startTime} - ${next.endTime}</div></div><span class=\"badge badge-orange\">En ${Math.floor(next.timeDiff/60)}h ${next.timeDiff%60}m</span></div>` : 'No hay próximos horarios programados';
            }
            if(historial){
                historial.innerHTML = premiumAlerts.length? premiumAlerts.slice().reverse().map(a=>`<div style=\"display:flex; justify-content:space-between;\"><div>${a.message}<div class=\"muted\">${a.schedule.name}</div></div><span class=\"muted\">${a.timestamp.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'})}</span></div>`).join('') : '—';
            }
        }

        function getNextPremiumSchedule(){
            const now=new Date(); const hh=now.getHours(); const mm=now.getMinutes(); const isWeekend=now.getDay()===0 || now.getDay()===6;
            let next=null; let min=24*60;
            for(const s of premiumSchedules){
                if(s.weekendOnly && !isWeekend) continue;
                const [sh,sm]=s.startTime.split(':').map(Number); let diff=(sh*60+sm)-(hh*60+mm); if(diff<0) diff+=24*60; if(diff<min){min=diff; next={...s, timeDiff:diff};}
            }
            return next;
        }

        setInterval(checkPremiumTime, 60000);
        checkPremiumTime();

        /* ==== Mapa de calor: datos y funciones ==== */
        const zonasArgentina = {
            'Buenos Aires': { premium: [
                { nombre: 'Puerto Madero', ganancia: 1400, multiplicador: 1.6 },
                { nombre: 'Palermo', ganancia: 1250, multiplicador: 1.4 },
                { nombre: 'Belgrano', ganancia: 1180, multiplicador: 1.35 },
                { nombre: 'Recoleta', ganancia: 1150, multiplicador: 1.3 },
                { nombre: 'Las Cañitas', ganancia: 1100, multiplicador: 1.25 },
                { nombre: 'Villa Crespo', ganancia: 950, multiplicador: 1.1 }
            ], horarios: {
                'Puerto Madero': ['7:00-9:30', '12:00-14:00', '18:30-22:00'],
                'Palermo': ['7:30-9:00', '12:30-15:00', '19:00-23:00'],
                'Belgrano': ['7:00-9:00', '12:00-14:30', '18:00-21:30']
            }, zonasBajas: ['La Boca', 'Barracas', 'Constitución'] },
            'Córdoba': { premium: [
                { nombre: 'Nueva Córdoba', ganancia: 950, multiplicador: 1.3 },
                { nombre: 'Centro', ganancia: 900, multiplicador: 1.2 },
                { nombre: 'Cerro de las Rosas', ganancia: 850, multiplicador: 1.15 },
                { nombre: 'Alto Palermo', ganancia: 800, multiplicador: 1.1 }
            ], horarios: {
                'Nueva Córdoba': ['7:00-9:00', '12:00-14:00', '19:00-22:00'],
                'Centro': ['7:30-9:30', '12:30-14:30', '18:30-21:30']
            }, zonasBajas: ['San Vicente', 'Arguello'] },
            'Rosario': { premium: [
                { nombre: 'Centro', ganancia: 850, multiplicador: 1.25 },
                { nombre: 'Pichincha', ganancia: 800, multiplicador: 1.2 },
                { nombre: 'Fisherton', ganancia: 750, multiplicador: 1.15 },
                { nombre: 'Echesortu', ganancia: 700, multiplicador: 1.1 }
            ], horarios: {
                'Centro': ['7:00-9:00', '12:00-14:00', '18:30-21:30'],
                'Pichincha': ['7:30-9:30', '12:30-14:30', '19:00-22:00']
            }, zonasBajas: ['Empalme Graneros', 'La Tablada'] },
            'Mendoza': { premium: [
                { nombre: 'Ciudad Centro', ganancia: 800, multiplicador: 1.3 },
                { nombre: 'Las Heras', ganancia: 750, multiplicador: 1.2 },
                { nombre: 'Godoy Cruz', ganancia: 700, multiplicador: 1.15 },
                { nombre: 'Maipú', ganancia: 650, multiplicador: 1.1 }
            ], horarios: {
                'Ciudad Centro': ['7:00-9:00', '12:00-14:00', '19:00-21:30'],
                'Las Heras': ['7:30-9:30', '12:30-14:30', '18:30-21:00']
            }, zonasBajas: ['Luján de Cuyo', 'Tupungato'] },
            'Salta': { premium: [
                { nombre: 'Centro Histórico', ganancia: 700, multiplicador: 1.25 },
                { nombre: 'Nueva Salta', ganancia: 650, multiplicador: 1.15 },
                { nombre: 'Tres Cerritos', ganancia: 600, multiplicador: 1.1 }
            ], horarios: { 'Centro Histórico': ['7:00-9:00', '12:00-14:00', '19:00-21:30'] },
              zonasBajas: ['Villa San Antonio', 'Cerrillos'] }
        };

        function detectarUbicacion(){
            const btn = document.getElementById('detectar-ubicacion'); if(!btn) return;
            btn.textContent='📍 Detectando...'; btn.disabled=true;
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(()=>{
                    const ciudades=Object.keys(zonasArgentina); const ciudad=ciudades[Math.floor(Math.random()*ciudades.length)];
                    mostrarAnalisisUbicacion(ciudad); btn.textContent='✅ Ubicación Detectada';
                },()=>{ mostrarSelectorCiudad(); btn.textContent='📍 Seleccionar Ciudad'; btn.disabled=false; });
            } else { mostrarSelectorCiudad(); btn.textContent='📍 Seleccionar Ciudad'; btn.disabled=false; }
        }
        function mostrarSelectorCiudad(){
            const container=document.querySelector('.ubicacion-detector'); if(!container) return;
            container.innerHTML=`<h3 style="color:white; margin-bottom:15px;">¿En qué ciudad trabajás?</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px;">
                    ${Object.keys(zonasArgentina).map(c=>`<button onclick=\"mostrarAnalisisUbicacion('${c}')\" class=\"ciudad-btn\">${c}</button>`).join('')}
                </div>`;
        }
        function mostrarAnalisisUbicacion(ciudad){
            const cd=document.getElementById('ciudad-detectada'); const ua=document.getElementById('ubicacion-actual');
            if(cd){ cd.textContent=ciudad; } if(ua){ ua.classList.remove('hidden'); }
            cargarZonasPremium(ciudad); analizarZonaActual(ciudad); mostrarComparacionZonas(ciudad); mostrarHorariosOptimos(ciudad);
        }
        function cargarZonasPremium(ciudad){
            const cont=document.getElementById('zonas-premium-list'); const data=zonasArgentina[ciudad]; if(!cont || !data){ if(cont) cont.innerHTML='<p>No hay datos disponibles</p>'; return; }
            let html=''; data.premium.forEach((z,i)=>{ html+=`<div class=\"zona-premium-item\" onclick=\"seleccionarZona('${ciudad}','${z.nombre}')\"><div><div class=\"zona-nombre-premium\">#${i+1} ${z.nombre}</div><div style=\"font-size:.8rem; color:#666;\">Multiplicador: ${z.multiplicador}x</div></div><div class=\"zona-ganancia\">$${z.ganancia}/hora</div></div>`; });
            html+='<div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee;">'; html+='<h4 style="color:#ff4757; font-size:.9rem; margin-bottom:10px;">⚠️ Zonas de Bajo Rendimiento:</h4>';
            data.zonasBajas.forEach(z=>{ html+=`<div style=\"background:#ffebee; color:#c62828; padding:8px 12px; border-radius:5px; margin-bottom:5px; font-size:.9rem;\">${z} - Ganancia estimada: 40-60% menos</div>`; }); html+='</div>'; cont.innerHTML=html;
        }
        function analizarZonaActual(ciudad){
            const cont=document.getElementById('analisis-zona-actual'); const data=zonasArgentina[ciudad]; if(!cont || !data) return;
            const disponibles=[...data.premium, ...data.zonasBajas.map(z=>({nombre:z, ganancia:400, multiplicador:0.6}))];
            const zona=disponibles[Math.floor(Math.random()*disponibles.length)]; const mejor=data.premium[0];
            const diferencia=mejor.ganancia - (zona.ganancia||400); const porcentaje=Math.round((diferencia/(zona.ganancia||400))*100);
            let color='#00ff88', status='Óptima', reco='¡Estás en una zona excelente! Mantente aquí durante los horarios pico.';
            if(porcentaje>50){ color='#ff4757'; status='Baja rentabilidad'; reco=`Considerá moverte a ${mejor.nombre} para ganar $${diferencia} más por hora.`; }
            else if(porcentaje>20){ color='#ffa502'; status='Mejorable'; reco=`Podrías ganar $${diferencia} más por hora en ${mejor.nombre}.`; }
            cont.innerHTML=`<div style=\"display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;\"><div><strong>Zona Actual:</strong><br><span style=\"font-size:1.1rem;\">${zona.nombre}</span></div><div><strong>Estatus:</strong><br><span style=\"color:${color}; font-weight:bold;\">${status}</span></div></div><div style=\"background:#e3f2fd; padding:12px; border-radius:8px; border-left:4px solid #2196f3;\"><strong>💡 Recomendación:</strong><br>${reco}</div><div style=\"margin-top:15px;\"><strong>Ganancia actual estimada:</strong> <span style=\"color:#667eea; font-weight:bold; font-size:1.1rem;\">$${zona.ganancia||400}/hora</span></div>`;
        }
        function mostrarComparacionZonas(ciudad){
            const cont=document.getElementById('comparacion-ganancias-zonas'); const data=zonasArgentina[ciudad]; if(!cont || !data) return; let html='';
            const top=data.premium[0].ganancia; data.premium.forEach((z,i)=>{ const diff=i===0?0:Math.round(((top - z.ganancia)/z.ganancia)*100); const clase= diff===0?'' : 'negativa'; const signo = diff===0? '' : '-'; html+=`<div class=\"zona-comparacion\" onclick=\"navegarAZona('${z.nombre}', ${z.ganancia})\"><div class=\"zona-nombre\">${z.nombre}</div><div class=\"zona-potencial\">$${z.ganancia}/hora</div><div class=\"zona-diferencia ${clase}\">${diff===0?'TOP':`${signo}${diff}%`}</div></div>`; }); cont.innerHTML=html;
        }
        function mostrarHorariosOptimos(ciudad){
            const cont=document.getElementById('horarios-optimizados'); const data=zonasArgentina[ciudad]; if(!cont || !data || !data.horarios){ cont.innerHTML='<p>No hay datos de horarios para esta ciudad</p>'; return; }
            let html=''; Object.entries(data.horarios).forEach(([zona, hs])=>{ html+=`<div class=\"horario-zona-item\"><div class=\"horario-zona-titulo\">🔥 ${zona}</div><div class=\"horario-zona-detalle\"><strong>Horarios pico:</strong> ${hs.join(' • ')}</div><div style=\"margin-top:8px; font-size:.8rem; color:#666;\">💰 Ganancia máxima en estos horarios</div></div>`; });
            html+=`<div style=\"background: linear-gradient(45deg, #4CAF50, #45a049); color:white; padding:15px; border-radius:8px; margin-top:15px;\"><strong>💡 Consejos de horarios:</strong><br>• Mañanas (7-9): Ejecutivos y oficinistas<br>• Mediodías (12-14): Almuerzos de negocios<br>• Noches (19-22): Vida nocturna y cenas<br>• Viernes/Sábados: +25% de demanda promedio</div>`; cont.innerHTML=html;
        }
        function seleccionarZona(ciudad,nombre){ const z=zonasArgentina[ciudad].premium.find(x=>x.nombre===nombre); if(!z) return; mostrarModalZona(ciudad,z); }
        function mostrarModalZona(ciudad,zona){ const modal=document.createElement('div'); modal.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000;'; modal.innerHTML=`<div style=\"background:white; border-radius:15px; padding:30px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto;\"><div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;\"><h2 style=\"color:#667eea; margin:0;\">📍 ${zona.nombre}</h2><button onclick=\"this.closest('div').parentNode.remove()\" style=\"background:#ff4757; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer;\">×</button></div><div style=\"display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;\"><div style=\"text-align:center; padding:15px; background:#f8f9ff; border-radius:10px;\"><div style=\"font-size:2rem; color:#00ff88; font-weight:bold;\">$${zona.ganancia}</div><div style=\"color:#666;\">Ganancia/hora</div></div><div style=\"text-align:center; padding:15px; background:#f8f9ff; border-radius:10px;\"><div style=\"font-size:2rem; color:#667eea; font-weight:bold;\">${zona.multiplicador}x</div><div style=\"color:#666;\">Multiplicador</div></div></div><div style=\"background:#e8f5e8; padding:15px; border-radius:10px; margin-bottom:15px;\"><strong>🚀 Proyección diaria:</strong><br>• 8 horas: $${zona.ganancia*8}<br>• Con multiplicador: $${Math.round(zona.ganancia*8*zona.multiplicador)}<br>• Ganancia extra: $${Math.round(zona.ganancia*8*(zona.multiplicador-1))}</div><div style=\"background:#fff3cd; padding:15px; border-radius:10px; margin-bottom:20px;\"><strong>⏰ Mejores horarios en ${zona.nombre}:</strong><br>${zonasArgentina[ciudad].horarios[zona.nombre]? zonasArgentina[ciudad].horarios[zona.nombre].join(' • ') : 'Consultar horarios locales'}</div><button onclick=\"navegarAZona('${zona.nombre}', ${zona.ganancia}); this.closest('div').parentNode.remove();\" style=\"width:100%; background: linear-gradient(45deg, #667eea, #764ba2); color:white; border:none; padding:15px; border-radius:25px; font-weight:bold; cursor:pointer; font-size:1.1rem;\">🧭 Navegar a ${zona.nombre}</button></div>`; document.body.appendChild(modal); }
        function navegarAZona(nombre,gan){ if(confirm(`¿Quieres navegar a ${nombre}? (Ganancia estimada: $${gan}/hora)`)){ alert(`🚀 Iniciando navegación a ${nombre}...`); guardarZonaSeleccionada(nombre,gan);} }
        function guardarZonaSeleccionada(zona,ganancia){ const hist=JSON.parse(localStorage.getItem('historialZonas')||'[]'); hist.push({zona,ganancia,fecha:new Date().toISOString(),timestamp:Date.now()}); if(hist.length>50){ hist.splice(0,hist.length-50);} localStorage.setItem('historialZonas', JSON.stringify(hist)); actualizarEstadisticasZonas(); }
        function actualizarEstadisticasZonas(){ const hist=JSON.parse(localStorage.getItem('historialZonas')||'[]'); if(hist.length===0) return; const frecu={}; let total=0; hist.forEach(r=>{ frecu[r.zona]=(frecu[r.zona]||0)+1; total+=r.ganancia; }); const fav=Object.entries(frecu).sort((a,b)=>b[1]-a[1])[0]; const prom=Math.round(total/hist.length); if(hist.length%10===0){ mostrarNotificacionEstadisticas(fav[0], prom, hist.length); } }
        function mostrarNotificacionEstadisticas(zonaFav, ganProm, total){ const n=document.createElement('div'); n.style.cssText='position:fixed; top:20px; right:20px; background:linear-gradient(45deg,#4CAF50,#45a049); color:white; padding:15px 20px; border-radius:10px; z-index:1001; box-shadow:0 4px 15px rgba(0,0,0,.3); max-width:300px;'; n.innerHTML=`<strong>📊 Estadísticas Actualizadas</strong><br>🏆 Zona favorita: ${zonaFav}<br>💰 Ganancia promedio: $${ganProm}/hora<br>📍 Zonas visitadas: ${total}`; document.body.appendChild(n); setTimeout(()=>n.remove(),5000); }
        function agregarEstilosCiudad(){ const style=document.createElement('style'); style.textContent=`.ciudad-btn{background:white;color:#667eea;border:2px solid transparent;padding:12px 20px;border-radius:25px;font-weight:600;cursor:pointer;transition:all .3s ease;font-size:.9rem}.ciudad-btn:hover{background:#667eea;color:white;transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.3)}.hidden{display:none!important}.zona-premium-item:hover{transform:translateX(5px); box-shadow:0 3px 10px rgba(0,0,0,.1)}.zona-comparacion:hover{background:#f0f8ff!important; cursor:pointer}`; document.head.appendChild(style);} 
        document.addEventListener('DOMContentLoaded', ()=>{ agregarEstilosCiudad(); const btn=document.getElementById('detectar-ubicacion'); if(btn) btn.addEventListener('click', detectarUbicacion); initLiveTripCounter(); initChallengeMode(); initRealData(); });

        // ==== Live Trip Counter (vanilla) ====
        function initLiveTripCounter(){
            const state = {
                isActive:false, isPaused:false, workTime:0, sessionStart:null,
                platforms:[
                    { id:'uber', name:'Uber', color:'#111827', multiplier:1.2 },
                    { id:'rappi', name:'Rappi', color:'#f97316', multiplier:1.0 },
                    { id:'didi', name:'Didi', color:'#3b82f6', multiplier:1.1 },
                    { id:'pedidosya', name:'PedidosYa', color:'#ef4444', multiplier:1.15 }
                ],
                trip:{ startTime:null, duration:0, platform:'uber', estimatedEarning:0, distance:0, status:'waiting' },
                daily:{ trips:0, earnings:0, hours:0, distance:0, avgPerTrip:0, efficiency:0 }
            };
            let timer=null, tripTimer=null;
            const $=id=>document.getElementById(id);
            const fmtTime=s=>{const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),t=s%60;return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(t).padStart(2,'0')}`};
            const fmtMoney=n=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',minimumFractionDigits:0}).format(n).replace('ARS','$');
            function renderPlatforms(){ const root=$('ltc-platforms'); if(!root) return; root.innerHTML=''; state.platforms.forEach(p=>{ const b=document.createElement('button'); b.className='ltc-chip'+(state.trip.platform===p.id?' active':''); b.textContent=p.name; b.style.color='#fff'; b.onclick=()=>{ state.trip.platform=p.id; renderTrip(); }; root.appendChild(b); }); }
            function renderHeader(){ const ind=$('ltc-indicator'), st=$('ltc-status'); if(!ind||!st) return; ind.style.background=(state.isActive&&!state.isPaused)?'#22c55e':(state.isPaused?'#f59e0b':'#6b7280'); st.textContent=(state.isActive&&!state.isPaused)?'ACTIVO':(state.isPaused?'EN PAUSA':'INACTIVO'); }
            function renderWork(){ const el=$('ltc-worktime'); if(el) el.textContent=fmtTime(state.workTime); }
            function renderTrip(){ $('ltc-trip-status').textContent= state.trip.status==='waiting'?'Esperando': state.trip.status==='en_route'?'En camino': state.trip.status==='delivering'?'Entregando':'¡Completado!'; $('ltc-trip-duration').textContent=fmtTime(state.trip.duration); $('ltc-trip-distance').textContent=`${state.trip.distance.toFixed(1)} km`; $('ltc-trip-earning').textContent=fmtMoney(state.trip.estimatedEarning); $('ltc-trip-platform').textContent = state.platforms.find(p=>p.id===state.trip.platform).name; renderDaily(); }
            function renderDaily(){ $('ltc-d-trips').textContent=state.daily.trips; $('ltc-d-earnings').textContent=fmtMoney(state.daily.earnings); $('ltc-d-avg').textContent=fmtMoney(state.daily.avgPerTrip||0); $('ltc-d-hours').textContent=`${state.daily.hours.toFixed(1)}h`; }
            function updateRealtime(){ state.daily.hours=state.workTime/3600; state.daily.avgPerTrip= state.daily.trips>0? state.daily.earnings/state.daily.trips:0; state.daily.efficiency = state.daily.hours>0? (state.daily.earnings/state.daily.hours):0; renderDaily(); }
            function startSession(){ state.isActive=true; state.isPaused=false; state.sessionStart=new Date(); state.workTime=0; clearInterval(timer); timer=setInterval(()=>{ if(state.isActive&&!state.isPaused){ state.workTime++; if(state.workTime%30===0) updateRealtime(); renderWork(); } },1000); renderHeader(); }
            function pauseSession(){ state.isPaused=!state.isPaused; renderHeader(); }
            function stopSession(){ state.isActive=false; state.isPaused=false; clearInterval(timer); clearInterval(tripTimer); state.trip.status='waiting'; state.trip.duration=0; state.trip.distance=0; state.trip.estimatedEarning=0; renderHeader(); renderTrip(); }
            function startTrip(){ if(!state.isActive) return; state.trip.startTime=new Date(); state.trip.duration=0; state.trip.distance=0; state.trip.estimatedEarning=5+Math.random()*10; state.trip.status='en_route'; clearInterval(tripTimer); tripTimer=setInterval(()=>{ if(state.trip.status!=='completed'){ state.trip.duration++; state.trip.distance+=Math.random()*0.1; state.trip.estimatedEarning+=Math.random()*0.05; renderTrip(); } },1000); }
            function completeTrip(){ const mult=state.platforms.find(p=>p.id===state.trip.platform).multiplier; const earn=state.trip.estimatedEarning*mult; state.daily.trips++; state.daily.earnings+=earn; state.daily.distance+=state.trip.distance; state.trip.status='completed'; renderTrip(); updateRealtime(); setTimeout(()=>{ state.trip.status='waiting'; state.trip.duration=0; state.trip.distance=0; state.trip.estimatedEarning=0; renderTrip(); },1200); }
            $('ltc-start')?.addEventListener('click', startSession);
            $('ltc-pause')?.addEventListener('click', pauseSession);
            $('ltc-stop')?.addEventListener('click', stopSession);
            $('ltc-trip-start')?.addEventListener('click', startTrip);
            $('ltc-trip-complete')?.addEventListener('click', completeTrip);
            renderPlatforms(); renderHeader(); renderWork(); renderTrip(); renderDaily();
        }

        // ==== Modo Challenge (vanilla) ====
        function initChallengeMode(){
            const $ = (id)=>document.getElementById(id);
            const fmtTime = (s)=>{const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),t=s%60;return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(t).padStart(2,'0')}`};
            const fmtMoney = (n)=> new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',minimumFractionDigits:0}).format(n).replace('ARS','$');

            const challenges = {
                facil: [
                    { id:'starter', name:'Primer Paso', icon:'🎯', target:{ earnings:4000, time:6 }, description:'Gana $4,000 en 6 horas', reward:100, strategy:'Mantén un ritmo constante, acepta viajes cortos' },
                    { id:'consistent', name:'Consistencia', icon:'⚡', target:{ trips:8, time:8 }, description:'Completa 8 viajes en 8 horas', reward:150, strategy:'Enfócate en zonas con demanda media' },
                    { id:'early_bird', name:'Madrugador', icon:'🌅', target:{ earnings:3000, time:4, timeWindow:'6-10' }, description:'Gana $3,000 entre 6-10 AM', reward:200, strategy:'Aprovecha la demanda matutina' }
                ],
                medio: [
                    { id:'daily_hero', name:'Héroe Diario', icon:'🏆', target:{ earnings:6000, time:8 }, description:'Gana $6,000 en 8 horas', reward:250, strategy:'6 viajes más en zona premium, tiempo estimado: 2.1 horas' },
                    { id:'zone_master', name:'Maestro de Zonas', icon:'🗺️', target:{ zones:5, earnings:7000, time:10 }, description:'Trabaja en 5 zonas diferentes y gana $7,000', reward:300, strategy:'Diversifica ubicaciones para maximizar demanda' },
                    { id:'efficiency_king', name:'Rey de Eficiencia', icon:'⚡', target:{ avgPerTrip:800, trips:10 }, description:'Promedio de $800+ por viaje en 10 viajes', reward:350, strategy:'Selecciona viajes de mayor valor, evita distancias cortas' }
                ],
                dificil: [
                    { id:'legendary', name:'Legendario', icon:'👑', target:{ earnings:10000, time:12, rating:4.8 }, description:'Gana $10,000 en 12 horas manteniendo 4.8+ rating', reward:500, strategy:'Combina volumen con calidad, zonas premium' },
                    { id:'iron_man', name:'Hombre de Hierro', icon:'🔥', target:{ earnings:8000, time:6, noBreaks:true }, description:'Gana $8,000 en 6 horas sin pausas', reward:600, strategy:'Máxima intensidad, zonas de alta rotación' },
                    { id:'multi_platform', name:'Multi-Plataforma', icon:'🎮', target:{ platforms:3, earnings:9000, time:10 }, description:'Usa 3 plataformas y gana $9,000', reward:550, strategy:'Optimiza según demanda de cada plataforma' }
                ]
            };

            const state = {
                selectedDifficulty:'medio',
                active:null,
                sessionActive:false,
                sessionTime:0,
                progress:{ earnings:0, trips:0, zones:new Set(), hours:0 },
                timer:null
            };

            function renderList(){
                const root = $('ch-list'); if(!root) return;
                const list = challenges[state.selectedDifficulty] || [];
                root.innerHTML = list.map(c=>`
                    <div class="ch-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-size:28px;">${c.icon}</div>
                            <div class="ch-badge" style="background:#a78bfa;">${c.reward} pts</div>
                        </div>
                        <div style="font-weight:700;">${c.name}</div>
                        <div class="muted" style="margin:6px 0 10px 0;">${c.description}</div>
                        <button class="ltc-btn" style="background:#6366f1; width:100%;" data-ch-id="${c.id}">INICIAR DESAFÍO</button>
                    </div>
                `).join('');
            }

            function calcProgress(){
                if(!state.active) return 0;
                const t = state.active.target; let total=0, count=0;
                if(t.earnings){ total += (state.progress.earnings / t.earnings)*100; count++; }
                if(t.trips){ total += (state.progress.trips / t.trips)*100; count++; }
                if(t.zones){ total += (state.progress.zones.size / t.zones)*100; count++; }
                return Math.min((count? total/count : 0), 100);
            }

            function updateUI(){
                $('ch-earn').textContent = fmtMoney(state.progress.earnings);
                $('ch-trips').textContent = String(state.progress.trips);
                $('ch-time').textContent = fmtTime(state.sessionTime);
                $('ch-zones').textContent = String(state.progress.zones.size);
                const p = calcProgress();
                $('ch-progress-text').textContent = `${p.toFixed(1)}%`;
                $('ch-progress-bar').style.width = `${p}%`;
                if(state.active){
                    $('ch-active-name').textContent = `${state.active.icon} ${state.active.name}`;
                    $('ch-active-desc').textContent = state.active.description;
                    $('ch-reward').textContent = `${state.active.reward} pts`;
                }
            }

            function start(ch){
                state.active = ch;
                state.sessionActive = true;
                state.sessionTime = 0;
                state.progress = { earnings:0, trips:0, zones:new Set(), hours:0 };
                clearInterval(state.timer);
                state.timer = setInterval(()=>{
                    if(!state.sessionActive || !state.active) return;
                    state.sessionTime += 1;
                    if(Math.random() < 0.10){
                        const addEarn = 50 + Math.random()*100;
                        const gotTrip = Math.random() < 0.03;
                        state.progress.earnings += addEarn;
                        if(gotTrip){ state.progress.trips += 1; state.progress.zones.add(`zona_${Math.floor(Math.random()*10)}`); }
                        state.progress.hours = state.sessionTime/3600;
                    }
                    updateUI();
                }, 1000);
                updateUI();
            }

            function pause(){ state.sessionActive = !state.sessionActive; }
            function reset(){ clearInterval(state.timer); state.active=null; state.sessionActive=false; state.sessionTime=0; state.progress={ earnings:0, trips:0, zones:new Set(), hours:0 }; updateUI(); }

            // Events
            $('ch-start')?.addEventListener('click', ()=>{
                if(!state.active){
                    // iniciar el primero de la dificultad por defecto
                    const first = (challenges[state.selectedDifficulty]||[])[0]; if(first) start(first);
                } else { state.sessionActive = true; }
            });
            $('ch-pause')?.addEventListener('click', pause);
            $('ch-reset')?.addEventListener('click', reset);
            $('ch-diff-easy')?.addEventListener('click', ()=>{ state.selectedDifficulty='facil'; renderList(); });
            $('ch-diff-medium')?.addEventListener('click', ()=>{ state.selectedDifficulty='medio'; renderList(); });
            $('ch-diff-hard')?.addEventListener('click', ()=>{ state.selectedDifficulty='dificil'; renderList(); });
            $('ch-list')?.addEventListener('click', (e)=>{
                const btn = e.target.closest('button[data-ch-id]'); if(!btn) return;
                const list = challenges[state.selectedDifficulty]||[]; const ch = list.find(x=>x.id===btn.getAttribute('data-ch-id'));
                if(ch) start(ch);
            });

            renderList(); updateUI();
        }

        window.iniciarGoogleAuth = iniciarGoogleAuth;
        window.cerrarSesion = cerrarSesion;
        window.getCurrentUser = () => currentUser;
        window.calcular = calcular;
        window.exportarPDF = exportarPDF;
        window.compartir = compartir;

        // ==== Datos Reales (vanilla) ====
        function initRealData(){
            const $ = (id)=>document.getElementById(id);
            const state = {
                isOnline: navigator.onLine,
                location: { province:null, city:null, coordinates:null, loading:true, error:null },
                platforms: {
                    uber:{ active:false, demand:0, surge:1, avgEarnings:0, estimatedTrips:0, zones:[], lastUpdate:null },
                    didi:{ active:false, demand:0, surge:1, avgEarnings:0, estimatedTrips:0, zones:[], lastUpdate:null },
                    pedidosya:{ active:false, demand:0, surge:1, avgEarnings:0, estimatedTrips:0, zones:[], lastUpdate:null },
                    rappi:{ active:false, demand:0, surge:1, avgEarnings:0, estimatedTrips:0, zones:[], lastUpdate:null }
                },
                metrics: { bestPlatform:null, hotZones:[], weatherImpact:1, trafficLevel:'normal', recommendations:[] }
            };

            const platformConfig = {
                uber:{ name:'Uber', color:'#000000', icon:'🚗' },
                didi:{ name:'DiDi', color:'#FF6B35', icon:'🚘' },
                pedidosya:{ name:'PedidosYa', color:'#E53E3E', icon:'🍕' },
                rappi:{ name:'Rappi', color:'#FF6B35', icon:'🛵' }
            };

            function fmtMoney(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',minimumFractionDigits:0}).format(n).replace('ARS','$'); }
            function fmtLast(ts){ if(!ts) return 'Nunca'; const d=Date.now()-new Date(ts).getTime(); const m=Math.floor(d/60000); return m<1?'Ahora':`Hace ${m} min`; }

            // UI
            function renderOnline(){ const pill=$('rd-online'); if(!pill) return; pill.textContent= state.isOnline? 'Online':'Offline'; pill.style.background = state.isOnline? 'rgba(34,197,94,.2)':'rgba(239,68,68,.2)'; pill.style.color = state.isOnline? '#22c55e':'#ef4444'; }
            function renderLocation(){ const loc=$('rd-location'); const geo=$('rd-location-geo'); if(!loc||!geo) return; if(state.location.loading){ loc.textContent='Detectando...'; geo.textContent='—'; return; } if(state.location.error){ loc.textContent=state.location.error; geo.textContent='—'; return; } loc.textContent=`${state.location.city}, ${state.location.province}`; const c=state.location.coordinates; geo.textContent=`(${c.lat.toFixed(4)}, ${c.lng.toFixed(4)})`; }
            function renderPlatforms(){ const root=$('rd-platforms'); if(!root) return; root.innerHTML = Object.keys(platformConfig).map(key=>{ const d=state.platforms[key]; const active=d.active && state.isOnline; return `
                <div class="rd-card" style="border:${active?'1px solid rgba(34,197,94,.4)':'1px solid rgba(255,255,255,.15)'};">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <span style="font-size:24px;">${platformConfig[key].icon}</span>
                            <div>
                                <div style="font-weight:800;">${platformConfig[key].name}</div>
                                <div class="muted">${active?'Activo':'Inactivo'}</div>
                            </div>
                        </div>
                        <div style="width:10px;height:10px;border-radius:50%; background:${active?'#22c55e':'#6b7280'};"></div>
                    </div>
                    ${active? `
                    <div class="muted" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>Demanda</span>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <div style="width:90px; height:8px; background:#374151; border-radius:999px; overflow:hidden;">
                                <div style="width:${d.demand}%; height:8px; background:linear-gradient(90deg,#ef4444,#22c55e);"></div>
                            </div>
                            <span style="font-weight:800;">${d.demand}%</span>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:6px;">
                        <span class="muted">Multiplicador</span><span style="font-weight:800; color:${d.surge>1.5?'#f87171':d.surge>1.2?'#fbbf24':'#22c55e'}">${d.surge}x</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:6px;">
                        <span class="muted">Ganancia promedio</span><span style="font-weight:800; color:#22c55e;">${fmtMoney(d.avgEarnings)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:6px;">
                        <span class="muted">Viajes estimados</span><span style="font-weight:800;">${d.estimatedTrips}/día</span>
                    </div>
                    <div class="muted" style="margin-top:6px;">Actualizado: ${fmtLast(d.lastUpdate)}</div>
                    `:
                    `<div style="text-align:center; padding:16px; color:#9ca3af;">Sin datos disponibles</div>`}
                </div>`; }).join(''); }
            function renderRecommendations(){ const root=$('rd-recs'); if(!root) return; const recs=state.metrics.recommendations||[]; if(!recs.length){ root.innerHTML=''; return; } root.innerHTML = `<h3 style="margin-top:0;">Recomendaciones en tiempo real</h3>` + recs.map(r=>`<div style="margin-top:8px; padding:10px; border-left:4px solid ${r.priority==='high'?'#ef4444':r.priority==='medium'?'#f59e0b':'#3b82f6'}; background:rgba(255,255,255,.06); border-radius:8px;"> <div style="font-weight:800; margin-bottom:4px;">${r.message}</div><div class="muted">${r.detail||''}</div></div>`).join(''); }
            function renderHotZones(){ const root=$('rd-hotzones'); if(!root) return; const zones=state.metrics.hotZones||[]; if(!zones.length){ root.innerHTML=''; return; } root.innerHTML = `<h3 style="margin-top:0;">Zonas calientes cercanas</h3>` + `<div class="rd-grid">` + zones.map((z,i)=>`<div class="rd-card"><div style=\"display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;\"><div style=\"font-weight:800;\">${z.name}</div><span class=\"rd-badge\" style=\"background:rgba(59,130,246,.25);\">#${i+1}</span></div><div class=\"muted\" style=\"display:flex; justify-content:space-between;\"><span>Demanda</span><span>${z.demandLevel}/5</span></div><div class=\"muted\" style=\"display:flex; justify-content:space-between;\"><span>Espera</span><span>${z.avgWaitTime} min</span></div><div class=\"muted\" style=\"display:flex; justify-content:space-between;\"><span>Surge</span><span>${z.surgeMultiplier.toFixed(1)}x</span></div><div class=\"muted\" style=\"margin-top:6px;\">${platformConfig[z.platform]?.icon||'📦'} ${platformConfig[z.platform]?.name||''}</div></div>`).join('') + `</div>`; }

            // Geo
            async function getCurrentLocation(){ state.location.loading=true; renderLocation(); if(!navigator.geolocation){ state.location={...state.location,loading:false,error:'Geolocalización no soportada'}; renderLocation(); return; } const options={ enableHighAccuracy:true, timeout:10000, maximumAge:60000 }; navigator.geolocation.getCurrentPosition(async (pos)=>{ const { latitude, longitude } = pos.coords; try{ const resp=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=es`); if(resp.ok){ const data=await resp.json(); state.location={ province:data.principalSubdivision||'Provincia no detectada', city:data.city||data.locality||'Ciudad no detectada', coordinates:{lat:latitude,lng:longitude}, loading:false, error:null }; } else { throw new Error('Reverse geocode error'); } }catch(e){ state.location={...state.location, loading:false, error:'Error al determinar la ubicación exacta'}; } renderLocation(); if(state.location.coordinates) updateAllPlatforms(); }, (err)=>{ const map={1:'Permiso de ubicación denegado',2:'Ubicación no disponible',3:'Tiempo de espera agotado'}; state.location={...state.location, loading:false, error: map[err.code]||'Error al obtener ubicación'}; renderLocation(); }, options); }

            // Mock data
            function generateHotZones(coords, platform){ if(!coords) return []; const out=[]; for(let i=0;i<5;i++){ const ol=(Math.random()-.5)*0.1, og=(Math.random()-.5)*0.1; out.push({ id:`${platform}_zone_${i}`, name:getZoneName(coords.lat+ol, coords.lng+og), coordinates:{ lat:coords.lat+ol, lng:coords.lng+og }, demandLevel: Math.floor(Math.random()*5)+1, avgWaitTime: Math.floor(Math.random()*15)+2, surgeMultiplier: 1 + (Math.random()*2), platform }); } return out; }
            function getZoneName(){ const names=['Centro','Puerto Madero','Palermo','Belgrano','Villa Crespo','San Telmo','La Boca','Recoleta','Barrio Norte','Caballito','Flores','Once','Abasto','Villa Urquiza']; return names[Math.floor(Math.random()*names.length)]; }
            function getWeatherImpact(){ return 1 + (Math.random()*0.4 - 0.2); }
            function getTrafficLevel(){ const levels=['bajo','normal','alto','muy_alto']; return levels[Math.floor(Math.random()*levels.length)]; }

            async function fetchPlatformData(platform, coords){ const base={ uber:{demand:1.2,earnings:800}, didi:{demand:1.0,earnings:650}, pedidosya:{demand:1.1,earnings:720}, rappi:{demand:1.3,earnings:900} };
                const time=new Date(); const h=time.getHours(); const w=[0,6].includes(time.getDay()); const peak=(h>=7&&h<=9)||(h>=12&&h<=14)||(h>=19&&h<=22); let df=1; if(peak) df+=0.4; if(w) df+=0.2; if(h>=22||h<=6) df+=0.6; const mult=base[platform]; const surge= Number((1 + (Math.random()*df*0.8)).toFixed(1)); return new Promise(res=> setTimeout(()=> res({ active: Math.random()>0.3, demand: Math.min(100, Math.floor(50 + (Math.random()*50*df))), surge, avgEarnings: Math.floor(mult.earnings * surge * df), estimatedTrips: Math.floor(8 + (Math.random()*12*df)), zones: generateHotZones(coords, platform), lastUpdate:new Date().toISOString() }), Math.random()*1200 + 400)); }

            async function updateAllPlatforms(){ if(!state.location.coordinates) return; const keys=Object.keys(platformConfig); const updates={}; for(const k of keys){ // secuencial para simplicidad
                    // eslint-disable-next-line no-await-in-loop
                    const data = await fetchPlatformData(k, state.location.coordinates); if(data) updates[k]=data; }
                state.platforms = { ...state.platforms, ...updates }; renderPlatforms(); calculateMetrics(updates); renderRecommendations(); renderHotZones(); }

            function calculateMetrics(data){ const active = Object.entries(data).filter(([,v])=>v.active); if(!active.length) return; const best = active.reduce((b,[k,v])=>{ const s=v.avgEarnings * v.surge * (v.demand/100); const bs=b.info.avgEarnings * b.info.surge * (b.info.demand/100); return s>bs? { platform:k, info:v } : b; }); const zones = active.flatMap(([p,info])=> info.zones.map(z=>({ ...z, platform:p }))); const hot = zones.sort((a,b)=> b.demandLevel-a.demandLevel).slice(0,5); const recs = generateRecommendations(active); state.metrics={ bestPlatform: best.platform, hotZones: hot, weatherImpact: getWeatherImpact(), trafficLevel: getTrafficLevel(), recommendations: recs }; }

            function generateRecommendations(active){ const recs=[]; const bestEarn = Math.max(...active.map(([,i])=> i.avgEarnings)); const best = active.find(([,i])=> i.avgEarnings===bestEarn); if(best){ const pf=best[0]; recs.push({ type:'platform', priority:'high', message:`Cambiar a ${platformConfig[pf].name}`, detail:`Ganancias promedio: ${fmtMoney(bestEarn)}`, platform: pf }); }
                const h=new Date().getHours(); if(h>=11&&h<=14){ recs.push({ type:'timing', priority:'medium', message:'Hora pico de almuerzo', detail:'Mayor demanda de delivery hasta las 15:00' }); }
                recs.push({ type:'weather', priority:'low', message:'Condiciones normales', detail:'Sin impacto significativo por clima' }); return recs; }

            // events
            $('rd-refresh')?.addEventListener('click', updateAllPlatforms);
            $('rd-retry')?.addEventListener('click', getCurrentLocation);
            window.addEventListener('online', ()=>{ state.isOnline=true; renderOnline(); });
            window.addEventListener('offline', ()=>{ state.isOnline=false; renderOnline(); });

            // init
            renderOnline(); renderLocation(); renderPlatforms(); getCurrentLocation(); setInterval(()=>{ if(state.location.coordinates && state.isOnline){ updateAllPlatforms(); } }, 120000);
        }
    </script>
</body>
</html>


